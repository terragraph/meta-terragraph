<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Routing_Layer">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Routing Layer | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Routing_Layer"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Routing Layer | Terragraph"><meta data-rh="true" name="description" content="This document gives a high-level description of Terragraph&#x27;s routing layer."><meta data-rh="true" property="og:description" content="This document gives a high-level description of Terragraph&#x27;s routing layer."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Routing_Layer"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Routing_Layer" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Routing_Layer" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.0199c3c1.js" as="script">
<link rel="preload" href="/assets/js/main.c2ab4c5b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Communication_Protocol">Communication Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Routing_Layer">Routing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Interface">Driver Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Stack">Driver Stack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/VPP_Implementation">VPP Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/WiFi">Wi-Fi</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Routing Layer</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Routing Layer</h1><p>This document gives a high-level description of Terragraph&#x27;s routing layer.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="network-topology">Network Topology<a class="hash-link" href="#network-topology" title="Direct link to heading">​</a></h2><p>Terragraph is a wireless mesh network comprised of &quot;distribution nodes&quot; (DN) and
&quot;client nodes&quot; (CN). One or more DNs must have fiber connectivity to the
Internet, and are designated as a &quot;points of presence&quot; (POP). The remaining DNs
are responsible for transferring traffic over multiple hops to and from the CNs.
Both DNs and CNs are connection points for wireless access points (APs) and
other customer premise equipment (CPE) to connect to the Internet.</p><p align="center"><img loading="lazy" src="/figures/deployment.png" width="1000" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="routing">Routing<a class="hash-link" href="#routing" title="Direct link to heading">​</a></h2><h3 class="anchor anchorWithStickyNavbar_LWe7" id="about-openr">About Open/R<a class="hash-link" href="#about-openr" title="Direct link to heading">​</a></h3><p>Terragraph uses <a href="https://github.com/facebook/openr" target="_blank" rel="noopener noreferrer">Open/R</a> as its routing platform. Open/R is comprised of several
distinct modules, and uses <a href="https://github.com/facebook/fbthrift" target="_blank" rel="noopener noreferrer">fbthrift</a> for serialization and transit. The core
module in Open/R is the distributed, eventually-consistent key-value store,
named <code>KvStore</code>, which is used to disseminate information such as routing
adjacencies and network prefixes across the entire network; this is used to
implement a link-state routing protocol.</p><p>In short, Open/R computes routes by building a graph using the adjacency and
prefix information in the key-value store. It runs a weighted shortest-paths
algorithm to all other nodes, and uses equal-cost multi-path routing (ECMP) when
multiple &quot;best paths&quot; exist. The best next-hops are then programmed into
hardware.</p><p>Open/R&#x27;s modules are listed below.</p><table><thead><tr><th>Module</th><th>Description</th></tr></thead><tbody><tr><td><code>KvStore</code></td><td>Distributed key-value store</td></tr><tr><td><code>LinkMonitor</code></td><td>Link discovery and monitoring module</td></tr><tr><td><code>Spark</code></td><td>Neighbor discovery module</td></tr><tr><td><code>Decision</code></td><td>Route computation module</td></tr><tr><td><code>Fib</code></td><td>Route programming module</td></tr><tr><td><code>PrefixManager</code></td><td>Prefix management module</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="openr-cli">Open/R CLI<a class="hash-link" href="#openr-cli" title="Direct link to heading">​</a></h3><p>Open/R provides a Python command-line interface, <code>breeze</code>, to interact with each
of its modules over Thrift.</p><p>In Terragraph, <code>breeze</code> is replaced with a lightweight Lua version called
<code>puff</code>. Usage is largely the same, and <code>puff</code> implements most of the original
CLI&#x27;s commands. <code>puff</code> source code resides in <code>src/terragraph-e2e/lua/puff.lua</code>,
and unit tests are located in <code>src/terragraph-e2e/lua/tests/puff_test.lua</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terragraph-routing">Terragraph Routing<a class="hash-link" href="#terragraph-routing" title="Direct link to heading">​</a></h3><p>Each Terragraph node runs an <code>openr</code> process. On Puma hardware, nodes run an
additional <code>fib_vpp</code> process to program routes into <a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a>&#x27;s FIB.</p><p>To route Internet traffic, all POP sectors advertise a default prefix <code>::/0</code>,
and other sectors forward default traffic to the nearest POP. At the POP sector,
egress traffic is handled by either adding <em>static routes</em> in Terragraph&#x27;s <em>fib
implementation</em> or through <em>BGP peering</em>. These POP settings are configured in
the <code>popParams</code> structure in the node configuration.</p><p>Note that Open/R names nodes by their MAC addresses, but with a different
representation from E2E. For example, an E2E MAC address <code>00:00:00:10:0d:40</code> is
represented in Open/R as <code>node-00.00.00.10.0d.40</code>.</p><p>For CNs, Open/R supports running in &quot;leaf&quot; mode via the <code>set_leaf_node</code> flag.
Leaf nodes will only track a minimal set of keys in <code>KvStore</code>, reducing Open/R&#x27;s
memory footprint. This mode of operation is not in use on Puma hardware.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="openr-on-wigig-and-wired-interfaces">Open/R on WiGig and Wired interfaces<a class="hash-link" href="#openr-on-wigig-and-wired-interfaces" title="Direct link to heading">​</a></h3><p>Open/R by default is enabled on the WiGig <code>terraX</code> interfaces in the node
configuration using <code>OPENR_IFACE_REGEX_INCLUDE</code>. Since Open/R can only listen
and discover peers on the Linux interfaces, Linux tap interfaces are set up on
behalf of its VPP counterparts to allow forwarding of local or &quot;slowpath&quot;
traffic (in Puma VPP/Linux split architecture). Open/R discovers WiGig peers
over <code>terraX</code> while the actual VPP routing and FIB route programming is through
the corresponding <code>vpp-terraX</code> interface.</p><p>For Open/R over wired POP interfaces, <code>tapX</code> Linux interface should be added to
the <code>OPENR_IFACE_REGEX_INCLUDE</code> regular expression and the routing would be
through the <code>loopX</code> L3 interface which functions as a Bridged VLAN interface.
This is enabled by default in Puma configuration.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="openr-usage-in-e2e">Open/R Usage In E2E<a class="hash-link" href="#openr-usage-in-e2e" title="Direct link to heading">​</a></h2><p>All communication with Open/R occurs through the local <code>openr</code> process on a
node; the controller never connects to any node&#x27;s Open/R sockets directly, but
instead issues commands through a minion&#x27;s <code>OpenrClientApp</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="node-configuration">Node Configuration<a class="hash-link" href="#node-configuration" title="Direct link to heading">​</a></h3><p>E2E depends on <code>KvStore</code> to distribute important configuration values that are
needed before nodes can reach the controller, such as the controller URL
(<code>e2e-ctrl-url</code>) and network seed prefix (<code>e2e-network-prefix</code>). These key-value
pairs are located in the <code>kvstoreParams</code> map in the node configuration. Because
the key-value store is distributed, only one node needs to have this config set
(usually a POP node). These keys get injected during node startup in the
<code>pop_config</code> script, and <code>OpenrClientApp</code> periodically polls for them and
overwrites unexpected values.</p><p>To isolate access to Open/R, <code>OpenrClientApp</code> writes and periodically syncs keys
to a file <code>/tmp/mynetworkinfo</code>, which contains a JSON-serialized <code>NetworkInfo</code>
Thrift structure. Fields include the controller URL (primary and backup),
aggregator URL(s), network seed prefix, and DHCP/BGP configuration. This file is
read by the minion&#x27;s <code>Broker</code>, as well as the stats modules and Terragraph&#x27;s
<code>squire_linux</code> daemon.</p><p>The node configuration contains a number of settings for the Open/R program.
Before Open/R starts, a configuration template file
(<code>/etc/sysconfig/openr_config_template.txt</code>) is filled out using the node
configuration and written to <code>/var/run/openr_config.json</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prefix-allocation">Prefix Allocation<a class="hash-link" href="#prefix-allocation" title="Direct link to heading">​</a></h3><p>The controller can be set up to centrally allocate node prefixes, in place of
the default distributed allocation procedure. If enabled, the controller
constructs a <code>StaticAllocation</code> Thrift structure mapping each node name to its
prefix. This gets sent to <code>OpenrClientApp</code>, which then sets the <code>KvStore</code> key
<code>e2e-network-allocations</code> to this value. Open/R&#x27;s <code>PrefixAllocator</code> will use
this static allocation instead of the network seed prefix
(<code>e2e-network-prefix</code>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="mcs-based-routing">MCS-Based Routing<a class="hash-link" href="#mcs-based-routing" title="Direct link to heading">​</a></h3><p>E2E can be configured to automatically adjust Open/R link metrics (i.e. edge
weights in the shortest-paths routing graph) based on real-time statistics at
each node. Currently, the firmware reports the MCS (modulation and coding scheme
index) on each link to the minion&#x27;s <code>StatusApp</code> approximately every 100ms. The
minion will then set the link metric via <code>LinkMonitor</code> so that lower-quality
links (i.e. with lower MCS) are used less frequently than better ones. Link
metric changes are rate-limited to avoid causing frequent shortest-paths
re-computations across the network, using a combination of two methods. First is
a dampening algorithm, which ignores reported MCS values until seeing <em>N</em>
consecutive values that would either all increase or all decrease the current
link metric. The second is a token bucket, which fills at a rate <em>r</em> with a
maximum burst size <em>b</em>. Link metric changes are only allowed when a token is
available. Relevant options are located in the <code>openrParams.linkMetricConfig</code>
structure in the node configuration. All link metrics are effectively 1 by
default. <code>OpenrClientApp</code> periodically polls link metric information from
<code>LinkMonitor</code> and overwrites any unexpected values.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="soft-draining">Soft Draining<a class="hash-link" href="#soft-draining" title="Direct link to heading">​</a></h3><p>Individual links can be &quot;soft drained&quot; via the per-link parameters in the node
configuration, located at
<code>linkParamsOverride.&lt;macAddr&gt;.openrLinkParams.softDisable</code>. A soft-drained link
simply has a very high link metric (100000), and will be avoided unless no other
paths are possible. This configuration is handled by <code>OpenrClientApp</code>, which
sets the link metric in <code>LinkMonitor</code> in the same procedure as described above.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="fixed-link-metrics">Fixed Link Metrics<a class="hash-link" href="#fixed-link-metrics" title="Direct link to heading">​</a></h3><p>Similar to soft draining, links can have fixed metrics assigned to them via the
same procedure. This setting is defined in the node configuration at
<code>linkParamsOverride.&lt;macAddr&gt;.openrLinkParams.fixedMetric</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="routing-queries">Routing Queries<a class="hash-link" href="#routing-queries" title="Direct link to heading">​</a></h3><p>The controller exposes an API to fetch all shortest routes between a source and
destination node. <code>TopologyApp</code> periodically queries a node for a dump of
adjacencies (<code>AdjacencyDatabase</code>) and prefixes (<code>PrefixDatabase</code>) in <code>KvStore</code>
for the entire network. To answer route queries, <code>TopologyApp</code> then runs the
<code>Fib</code> shortest paths solver recursively from the source to destination node,
recording the best-hop at each step.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="bgp-implementation">BGP Implementation<a class="hash-link" href="#bgp-implementation" title="Direct link to heading">​</a></h2><p>Terragraph supports multiple <a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol" target="_blank" rel="noopener noreferrer">BGP</a> daemons. Logic for managing BGP applications
is captured in a BGP wrapper script (<code>/usr/sbin/bgp_wrapper.sh</code>). Currently,
Terragraph uses <a href="https://pypi.org/project/exabgp/" target="_blank" rel="noopener noreferrer">ExaBGP</a> by default, but will fall back on <a href="https://frrouting.org/" target="_blank" rel="noopener noreferrer">FRRouting</a> if ExaBGP
is not installed. E2E monitors BGP status on PoP nodes via calls to the
respective CLIs in the <code>BgpUtils</code> class.</p><p>A custom init.d script is installed to gracefully shut down BGP connections
before reboot (<code>/etc/init.d/bgp_softshut</code>). This will stop the BGP daemon and
send a BGP Cease Notification message to peers, withdraw the default route from
Open/R, and briefly wait while transit traffic drains from links.</p><p>This section will describe Terragraph&#x27;s BGP implementations for VPP-based
platforms only.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="exabgp">ExaBGP<a class="hash-link" href="#exabgp" title="Direct link to heading">​</a></h3><p><a href="https://pypi.org/project/exabgp/" target="_blank" rel="noopener noreferrer">ExaBGP</a> is a Python-based BGP application offering easy programmatic control.
<code>exabgpcli</code> exists to check ExaBGP state, operating on named pipes
(<code>/run/exabgp/exabgp.in</code>, <code>/run/exabgp/exabgp.out</code>).</p><p>ExaBGP forks a plugin named <code>exabgp-to-openr</code> which parses BGP messages in JSON
format, redistributes learned prefixes, and produces JSON to advertise prefixes.
The plugin exports and health-checks routes via a <a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer">Thrift</a> API to <code>fib_vpp</code> and
Open/R. <code>fib_vpp</code> installs the best routes into VPP&#x27;s <a href="https://en.wikipedia.org/wiki/Forwarding_information_base" target="_blank" rel="noopener noreferrer">FIB</a>. <code>exabgp-to-openr</code>
also performs health checks before the PoP node will advertise a prefix to its
BGP peers via <code>OpenRChecker</code>, which ensures that the PoP node has an allocated
prefix (on Linux&#x27;s <code>lo</code> interface) <em>or</em> the Open/R RIB has a subnet in the
desired prefix to advertise. Lastly, the plugin dynamically advertises/withdraws
CPE prefixes found in Open/R to BGP peers.</p><p>As ExaBGP starts up, a configuration generation process (<code>exaconf</code>) is run to
pull information from node configuration (<code>popParams</code> and <code>bgpParams</code>) and
generate the following files:</p><ul><li><code>/data/etc/exabgp/aioexabgp.conf</code>: JSON configuration controlling what
prefixes to advertise and learn</li><li><code>/data/etc/exabgp/exabgp.conf</code>: Standard ExaBGP configuration to control who
to peer with</li></ul><p>Useful log files are:</p><ul><li><code>/var/log/exabgp/current</code>: ExaBGP configuration generation and operation logs</li><li><code>/var/log/pop_config/current</code>: Output from configuring the node to be a PoP</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="frrouting">FRRouting<a class="hash-link" href="#frrouting" title="Direct link to heading">​</a></h3><p><a href="https://frrouting.org/" target="_blank" rel="noopener noreferrer">FRRouting</a> (or FRR) is a C-based suite of network routing protocols originally
forked from Quagga. It provides a long list of protocol daemons (such as <code>bgpd</code>)
which are centrally managed by a <code>zebra</code> process to handle communications with
the data plane. A unified shell, <code>vtysh</code>, exists to interface with all daemons.</p><p>The BGP wrapper script starts all services used by FRR:</p><ul><li><code>bgpd</code> - The FRR BGP daemon. The startup script generates the initial
configuration file, <code>/var/run/bgpd.conf</code>, from the node configuration via
<code>src/terragraph-e2e/lua/update_bgpd_conf.lua</code>.</li><li><code>zebra</code> - The FRR Zebra daemon. Zebra exposes a &quot;FIB push&quot; interface via a
Forwarding Plane Manager (FPM) module, which allows an external process to
connect and receive a complete copy of the forwarding tables over Netlink
messages.</li><li><code>frr_openr_sync</code> - A Lua service which connects to Zebra&#x27;s FPM socket and
syncs BGP routes with the <a href="https://en.wikipedia.org/wiki/Forwarding_information_base" target="_blank" rel="noopener noreferrer">FIB</a> (add/delete via <a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer">Thrift</a> API to <code>Fib</code> agent)
and Open/R (advertise/withdraw via <code>breeze</code> CLI).</li><li><code>frr_bgp_healthcheck</code> - A Lua service which health-checks and manages the
announcement of routes to <code>bgpd</code>. The service monitors all Terragraph prefixes
from the node configuration to ensure reachability before advertising them to
BGP peers (i.e. PoP loopback prefix is within the desired prefix, <em>or</em> the
Open/R RIB has a subnet in the desired prefix), and also monitors all CPE
prefixes found in Open/R. Any changes to advertised BGP routes are dynamically
applied to the FRR configuration via the <code>frr-reload</code> utility (see below).</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="frr-reload">frr-reload<a class="hash-link" href="#frr-reload" title="Direct link to heading">​</a></h4><p>The <code>frr-reload</code> utility (<code>src/terragraph-e2e/lua/frr_reload.lua</code>) is a Lua port
of the <code>frr-reload.py</code> Python script distributed with FRR. This utility compares
two FRR configurations (e.g. the running configuration against a desired
configuration file) and runs a sequence of <code>vtysh</code> commands to achieve the
target configuration without restarting any daemons. Only relevant portions of
the script, relating to BGP features discussed above, have been ported, and
other unused configuration sections are not implemented.</p><p>The script uses two internal classes to model FRR configuration:</p><ol><li><code>Context</code> - Represents a section of the configuration, where a <em>context</em> is
loosely defined as a series of lines with a unique configuration meaning when
grouped together. Some single-line contexts exist as well.</li><li><code>Config</code> - Groups together all unique contexts of the configuration.</li></ol><p>Contexts are parsed in <code>Config:loadContexts()</code> and compared in
<code>FrrReloadUtils.compareContextObjects()</code>. Applying the FRR configuration changes
requires two passes, where deletions of lines occurs only in the first pass.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="routing-for-ipv4">Routing for IPv4<a class="hash-link" href="#routing-for-ipv4" title="Direct link to heading">​</a></h2><p>Terragraph is a native IPv6 network. To enable IPv4-only Terragraph deployments,
where both access networks and/or ISP networks can be IPv4, a combination of L2
tunneling and NAT64 is recommended. L2 tunnels will be set up for all data-plane
traffic between POP nodes and CNs encapsulating IPv4 traffic with the
appropriate tunnel headers. NAT64 will handle IPv4 control-plane traffic to
Terragraph cloud services (e.g. E2E, NMS, Kafka, Fluentd).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="l2-tunneling">L2 Tunneling<a class="hash-link" href="#l2-tunneling" title="Direct link to heading">​</a></h3><p>Terragraph supports SRv6 and VXLAN tunneling options for data-plane traffic
between the POP nodes and CNs (currently only in VPP mode).</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="srv6">SRv6<a class="hash-link" href="#srv6" title="Direct link to heading">​</a></h4><p>SRv6 (Segment Routing) is the recommended solution for L2 tunneling, as it
provides a modular framework for L2 tunneling with SRv6 &quot;segments&quot; using the
native IPv6 header. An SRv6 L2 tunnel can be formed between a POP DN and a CN by
encapsulating an IPv6 header and SRv6 segment headers over an L2 frame carrying
IPv4 traffic.</p><p>To create an SRv6 L2 tunnel originating from a POP node and terminating at a CN,
an SRv6 encapsulation policy is defined on the POP interface
(<code>popParams.POP_IFACE</code>) or it&#x27;s VLAN sub-interface, which adds IPv6 + SRv6
headers on all L2 frames received on that interface. The destination for the
encapsulated SRv6 packets is an SRv6 decapsulation policy on the CN&#x27;s physical
CPE interfaces. The CN&#x27;s decapsulation policy then removes the IPv6 + SRv6
headers and send the L2 frames out to the CPE interface. Thus an SRv6 L2 tunnel
in the Terragraph network is a single SRv6 segment from one node to another. The
reverse tunnel from CN to POP node will have to be set up with the appropriate
encapsulation and decapsulation SRv6 policies.</p><p>In VPP mode, Terragraph supports multiple SRv6 tunnels on a single physical
interface with the help of 802.1Q VLANs by creating corresponding sub-interfaces
and adding SRv6 policies on the individual sub-interfaces. This enables
Terragraph operators to deploy multiple SRv6 tunnels from a POP node to multiple
CNs (for a MDU deployment) with each L2 tunnel having a unique combination of
VLAN, source and destination IP addresses. Hence there is a requirement for all
upstream and downstream traffic to be tagged correctly with a unique C-VLAN tag.</p><p>The SRv6 tunnel source and destination IPv6 addresses are formed from the node&#x27;s
own /64 address and the tunnel&#x27;s VLAN ID (C-VLAN tag). An SRv6 source
(encapsulation) IPv6 address is derived by adding the C-VLAN tag to <code>:1001</code>
along with the node&#x27;s /64 prefix. Similarly, the SRv6 destination
(decapsulation) address uses the C-VLAN tag added and a base <code>:2001</code> address.</p><p>Since SRv6 uses native IPv6 headers and the tunnel IP addresses are derived from
the node /64 prefixes, Open/R automatically handles the routing for the SRv6
packets without additional configuration.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="vxlan">VXLAN<a class="hash-link" href="#vxlan" title="Direct link to heading">​</a></h4><p>VXLAN (Virtual Extensible LAN) is another tunnel option that is supported in VPP
mode. VXLAN is an L2 overlay network over existing L3 networks and is
well-supported in both VPP and the Linux kernel. A VXLAN tunnel is formed
between two endpoints (via source and destination IP addresses) and encapsulates
an additional IPv6 + UDP + VXLAN header (56 bytes) on top of the L2 frames
that POP nodes and CNs receive over the wired interfaces. On POP nodes, the
VXLAN tunnel interfaces are created in bridge mode and added to the existing POP
bridge containing the POP interface. For CNs, the VXLAN tunnel interface is
cross-connected to the physical interface. Currently, all VXLAN tunnels are
placed on the same POP bridge and VLANs will be supported in the future.</p><p>VXLAN tunnel redundancy is supported in VPP mode. A backup VXLAN tunnel can be
optionally configured on CNs. A tunnel will be considered a backup tunnel if
<code>tunnelParams.primaryTunnelName</code> is present, and the value should be the name of
its corresponding primary tunnel. The primary tunnel is always the first choice
for carrying traffic. A CN will only switch to the backup tunnel if it detects
that the primary tunnel&#x27;s destination node is unreachable. Once the destination
node of the primary tunnel is back online, the CN will switch back to the
primary tunnel.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="l2-tunnel-configuration">L2 Tunnel Configuration<a class="hash-link" href="#l2-tunnel-configuration" title="Direct link to heading">​</a></h4><p>L2 tunneling can be enabled via the <code>tunnelConfig</code> node configuration field, as
illustrated below:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;tunnelConfig&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;tunnel1&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;enabled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;localInterface&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TenGigabitEthernet0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;dstIp&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2001::1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;dstNodeName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;node-fe-19-50-01-00-8f&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;tunnelType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VXLAN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;tunnelParams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;vlanId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;tunnel2&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;enabled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;localInterface&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;TenGigabitEthernet0&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;dstIp&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;3001::1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;dstNodeName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;node-fe-19-22-90-10-ef&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;tunnelType&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;VXLAN&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;tunnelParams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;vlanId&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;primaryTunnelName&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;tunnel1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>A <code>tunnelConfig</code> in each direction (between a POP node and CN) is required for
bi-directional traffic. While only SRv6 and VXLAN are fully supported in VPP,
any of <code>SRV6</code>, <code>VXLAN</code>, or <code>L2GRE</code> can be configured. The <code>dstIp</code> field is
auto-populated by the E2E controller using the given <code>dstNodeName</code>.</p><p>The <code>vpp_chaperone</code> service uses these values to configure the L2 tunnels
appropriately based on node type and tunnel type. For POP nodes, the POP
interface (<code>popParams.POP_IFACE</code>) should be the tunnel&#x27;s <code>localInterface</code> and is
the source interface for encapsulation. For CNs, <code>localInterface</code> should be the
CPE interface.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="nat64">NAT64<a class="hash-link" href="#nat64" title="Direct link to heading">​</a></h3><p>Terragraph networks require an IPv6 connection between the Terragraph cloud
services (e.g. E2E/NMS) and the nodes. To support IPv4 E2E/NMS, NAT64 (Network
Address Translation) on the POP 10G interface is the recommended solution to
convert control-place traffic between IPv4 and IPv6.</p><p>Stateful NAT64 is supported natively in VPP, and via the <a href="https://jool.mx/" target="_blank" rel="noopener noreferrer">Jool</a> modules in the
Linux kernel. With stateful NAT64, the POP node&#x27;s NAT64 interface exposes only
one IPv4 address to an external IPv4 host (e.g. E2E/NMS). For each IPv4 address
seen, it creates a flow using a unique port and performs associated
translations.</p><p>NAT64 is intended to be deployed only for control-plane traffic, and thus will
only be enabled on the POP interface (<code>popParams.POP_IFACE</code>). Within the IPv4
network, the IPv4 cloud services will only see a single IPv4 address
(<code>envParams.NAT64_IPV4_ADDR</code>) and use that to communicate with the IPv6
Terragraph network.</p><p>Terragraph uses static routing to handle IPv4 egress traffic. If E2E/NMS and
POP node(s) are deployed on different subnets, each POP node must enable static
routing (<code>popParams.POP_STATIC_ROUTING</code>) and specify the IPv4 address of the
upstream router (<code>popParams.GW_ADDR</code>).</p><p>NAT64 can be enabled via the node configuration fields shown below:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;popParams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;NAT64_POP_ENABLED&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;NAT64_IPV4_ADDR&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;198.51.100.2/24&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;NAT64_IPV6_PREFIX&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;64:ff9b::/96&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;GW_ADDR&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;198.51.100.1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;POP_STATIC_ROUTING&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;1&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;kvstoreParams&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;e2e-ctrl-url&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;tcp://[64:ff9b::203.0.113.1]:7012&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>External IPv4 addresses will be embedded with an IPv6 NAT64 prefix configured
through <code>NAT64_IPV6_PREFIX</code> (e.g. the well-known NAT64 prefix <code>64:ff9b::/96</code>).
The resulting IPv6 prefix (e.g. <code>64:ff9b::203.0.113.1</code>) will be used by the
IPv6 Terragraph nodes to communicate with the IPv4 cloud services. These cloud
services (and any other external IPv4 endpoints) must be configured with the
IPv6 representations for each IPv4 address.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="policing-and-classification">Policing and Classification<a class="hash-link" href="#policing-and-classification" title="Direct link to heading">​</a></h2><p>Packets that arrive on CPE interfaces with policers enabled in VPP are first
classified according to the DSCP field in the packet&#x27;s L3 header. Inbound
traffic is expected to be marked with DSCP corresponding to one of the assured
forwarding (AF) classes with low drop precedence (AFx1). Thus, the policer is
configured to recognize the DSCP values corresponding to each AFx1 class. All
other traffic will be treated by the policer as traffic class 3, green (AF11).
The policer will mark traffic using a two-rate/three-color policing function in
accordance with the assured forwarding per-hop-behavior (AF PHB) defined in RFC
2597. The standard defines 4 traffic classes and 3 colors per class. The AF DSCP
codes and names are as follows:</p><table><thead><tr><th></th><th>Class 1</th><th>Class 2</th><th>Class 3</th><th>Class 4</th></tr></thead><tbody><tr><td>Green</td><td>AF11 (10)</td><td>AF21 (18)</td><td>AF31 (26)</td><td>AF41 (34)</td></tr><tr><td>Yellow</td><td>AF12 (12)</td><td>AF22 (20)</td><td>AF32 (28)</td><td>AF42 (36)</td></tr><tr><td>Red</td><td>AF13 (14)</td><td>AF23 (22)</td><td>AF33 (30)</td><td>AF43 (38)</td></tr></tbody></table><p>VPP is configured to use a two-rate/three-color policing function following RFC
4115. A committed information rate (CIR) and excess information rate (EIR) are
defined for each traffic class. The peak information rate (PIR) is the sum of
the CIR and EIR. Committed burst size (CBS) and excess burst size (EBS) are
currently not manually configurable, and are set as the CIR and EIR values over
1 second, respectively. Traffic arriving under the CIR is marked green. Traffic
arriving over the CIR but under the PIR is marked yellow, and traffic over the
PIR is dropped (red). When the EIR is set as 0, a one-rate/two-color policer
will be created instead of a two-rate/three-color policer. Traffic under the CIR
will be marked green, and all other traffic will be dropped. The CIR and EIR are
set in node configuration like so:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;cpeConfig&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;TenGigabitEthernet0&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;policers&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;0&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;cir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;eir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;1&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;cir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;eir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;2&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;cir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;eir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token property" style="color:#36acaa">&quot;3&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;cir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;eir&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2000</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>cir</code> and <code>eir</code> are both in units of kilobytes per second.</p><p>In VPP the policers are bound to network interfaces by first defining a
classification table for that interface, then creating policers that match bits
in the packet header, assigning policing sessions to the classification table,
and finally associating the classification table with a network interface.
<code>vpp_chaperone</code> performs these actions according to the node configuration
settings.</p><p>The packet classification process is illustrated below:</p><p align="center"><img loading="lazy" src="/figures/packet_classification.svg" width="1000" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="hqos-configuration">HQoS Configuration<a class="hash-link" href="#hqos-configuration" title="Direct link to heading">​</a></h2><p>Packets that reach the WiGig net interfaces are scheduled by the TG HQoS module
in <a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a>. Each DSCP value a packet may hold has a corresponding traffic class,
color, and queue.</p><p>HQoS configuration is only supported on platforms using the VPP DPDK plugin.</p><p>Terragraph&#x27;s HQoS hierarchy uses 16 pipes per port (1 per WiGig peer), 4 traffic
classes per pipe, and 1 queue per traffic class. The number of traffic classes
and queues are determined by the constants
<code>TGHQOS_SCHED_TRAFFIC_CLASSES_PER_PIPE</code> and
<code>TGHQOS_SCHED_QUEUES_PER_TRAFFIC_CLASS</code>, and they can be modified to provide
more traffic classes or queues as necessary.</p><p>Compiled defaults for all configurations are found in
<code>vpp/src/plugins/dpdk/tghqos/tghqos.c</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vppctl">vppctl<a class="hash-link" href="#vppctl" title="Direct link to heading">​</a></h3><p>The DSCP to TC/color can be inspected by executing the following vppctl command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">vpp# tghqos show interface &lt;WiGig netif name&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Packet IPv6 DSCP field is used for tc, color, queue:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IPv6 DSCP data position offset:    8</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IPv6 DSCP data bitmask: 0x0000000000000fc0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Stats are being cleared on read: 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> TC translation table: ([Mapped Value Range]: tc/queue/color tc/queue/color ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [ 0 ..   7]: 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [ 8 ..  15]: 3/0/Y 3/0/Y 3/0/G 3/0/Y 3/0/Y 3/0/Y 3/0/R 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [16 ..  23]: 3/0/Y 3/0/Y 2/0/G 3/0/Y 2/0/Y 3/0/Y 2/0/R 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [24 ..  31]: 3/0/Y 3/0/Y 1/0/G 3/0/Y 1/0/Y 3/0/Y 1/0/R 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [32 ..  39]: 3/0/Y 3/0/Y 0/0/G 3/0/Y 0/0/Y 3/0/Y 0/0/R 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [40 ..  47]: 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [48 ..  55]: 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     [56 ..  63]: 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y 3/0/Y</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> Rate = 275000000 bytes/second</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>The above TC translation table is the default table when VPP launches. The TC
table may be directly edited from vppctl with the following command:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tghqos set tctbl entry &lt;dscp&gt; tc &lt;tc&gt; queue &lt;queue&gt; color &lt;color&gt;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="vpp_chaperone">vpp_chaperone<a class="hash-link" href="#vpp_chaperone" title="Direct link to heading">​</a></h3><p><code>vpp_chaperone</code> will edit the default TC translation table on boot according to
the node configuration. The TC translation table can be configured with the
following schema:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;qosConfig&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;dscpEntries&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;0&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;tc&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">3</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;queue&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Y&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;1&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;tc&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;queue&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Y&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;2&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;tc&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;queue&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;Y&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;3&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token property" style="color:#36acaa">&quot;tc&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;queue&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token property" style="color:#36acaa">&quot;color&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token string" style="color:#e3116c">&quot;G&quot;</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>Each entry in the TC table mapping is keyed on the DSCP value. Like the vppctl
command, the value of each entry has three attributes, <code>tc</code>, <code>queue</code>, and
<code>color</code>. <code>tc</code> may be valued <!-- -->[0, 3]<!-- -->, <code>queue</code> may only have value 0, and <code>color</code>
may be <code>R</code>, <code>G</code>, or <code>Y</code>. Any number of DSCP entries can be specified under
<code>mapping</code>. Missing DSCP entries take the default value.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="weighted-round-robin-scheduling">Weighted Round Robin Scheduling<a class="hash-link" href="#weighted-round-robin-scheduling" title="Direct link to heading">​</a></h3><p>Weighted round robin scheduling can be enabled for all interfaces using the VPP
startup configuration option <code>tghqos scheduling &lt;sched_alg&gt;</code> in the VPP startup
configuration file (<code>/var/run/vpp/startup.conf</code>). Traffic classes are assigned
a priority and a weight which can be configured with the VPP startup
configuration option <code>tghqos tc &lt;tc&gt; priority &lt;priority_level&gt; weight &lt;weight&gt;</code>.
Example:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">tghqos {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scheduling wrr</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tc 0 priority 1 weight 16</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>These can also be configured for an interface with the vppctl commands,
<code>tghqos set interface scheduling &lt;WiGig netif name&gt; &lt;sched_alg&gt;</code> and
<code>tghqos set interface wrr &lt;WiGig netif name&gt; tc &lt;tc&gt; priority &lt;priority&gt; weight &lt;weight&gt;</code>.</p><p>Configurations for each interface can be read with the command
<code>tghqos show interface &lt;WiGig netif name&gt;</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="cpe-configuration">CPE Configuration<a class="hash-link" href="#cpe-configuration" title="Direct link to heading">​</a></h2><p>This section briefly describes some implementation details around CPE
configuration for features which are not already covered above.</p><p>Terragraph nodes support one CPE interface in kernel mode and multiple CPE
interfaces in VPP mode. On Puma, a node can have up to 4 CPE interfaces.</p><p>CPE interface prefixes can be either manually assigned or automatically derived
based on node prefix. Stateless Address Autoconfiguration (SLAAC) and Router
Advertisement are configured on CPE interfaces automatically to enable prefix
assignment for CPE devices.</p><ul><li>In VPP mode, <code>vpp_chaperone</code> performs all CPE interface configuration. DHCPv6
prefix allocation for CPE devices is also supported through a DHCP relay via
the <code>cpeConfig.TenGigabitEthernetX.dhcpRelay</code> node configuration field.</li><li>In kernel mode, the <code>squire_linux</code> service configures and launches the <code>radvd</code>
and/or <code>dhcpd</code> daemons to program CPE prefixes and routes into Linux.</li></ul><p>A separate <code>cpe_operations</code> program handles CPE interface events,
advertises/withdraws CPE prefixes from Open/R, and manages hostapd instances per
CPE interface to provide 802.1X (see
<a href="/docs/developer/Security#security-wired-security">Wired Security</a> for details). This program
is invoked periodically by the <code>coop</code> service.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://en.wikipedia.org/wiki/Border_Gateway_Protocol" target="_blank" rel="noopener noreferrer">BGP</a> - Border Gateway Protocol</li><li><a href="https://pypi.org/project/exabgp/" target="_blank" rel="noopener noreferrer">ExaBGP</a> - Python-based BGP implementation</li><li><a href="https://frrouting.org/" target="_blank" rel="noopener noreferrer">FRRouting</a> - C-based routing protocol suite</li><li><a href="https://en.wikipedia.org/wiki/Forwarding_information_base" target="_blank" rel="noopener noreferrer">FIB</a> - Forwarding Information Base</li><li><a href="https://github.com/facebook/openr" target="_blank" rel="noopener noreferrer">Open/R</a> - Meta&#x27;s routing platform</li><li><a href="https://thrift.apache.org/" target="_blank" rel="noopener noreferrer">Thrift</a> - Meta&#x27;s interface definition language</li><li><a href="https://github.com/facebook/fbthrift" target="_blank" rel="noopener noreferrer">fbthrift</a> - Meta&#x27;s branch of Apache Thrift</li><li><a href="https://wiki.fd.io/view/VPP" target="_blank" rel="noopener noreferrer">VPP</a> - Vector Packet Processing</li><li><a href="https://jool.mx/" target="_blank" rel="noopener noreferrer">Jool</a> - SIIT and NAT64 for Linux</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Routing_Layer.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Communication_Protocol"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Communication Protocol</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Driver_Interface"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Driver Interface</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#network-topology" class="table-of-contents__link toc-highlight">Network Topology</a></li><li><a href="#routing" class="table-of-contents__link toc-highlight">Routing</a><ul><li><a href="#about-openr" class="table-of-contents__link toc-highlight">About Open/R</a></li><li><a href="#openr-cli" class="table-of-contents__link toc-highlight">Open/R CLI</a></li><li><a href="#terragraph-routing" class="table-of-contents__link toc-highlight">Terragraph Routing</a></li><li><a href="#openr-on-wigig-and-wired-interfaces" class="table-of-contents__link toc-highlight">Open/R on WiGig and Wired interfaces</a></li></ul></li><li><a href="#openr-usage-in-e2e" class="table-of-contents__link toc-highlight">Open/R Usage In E2E</a><ul><li><a href="#node-configuration" class="table-of-contents__link toc-highlight">Node Configuration</a></li><li><a href="#prefix-allocation" class="table-of-contents__link toc-highlight">Prefix Allocation</a></li><li><a href="#mcs-based-routing" class="table-of-contents__link toc-highlight">MCS-Based Routing</a></li><li><a href="#soft-draining" class="table-of-contents__link toc-highlight">Soft Draining</a></li><li><a href="#fixed-link-metrics" class="table-of-contents__link toc-highlight">Fixed Link Metrics</a></li><li><a href="#routing-queries" class="table-of-contents__link toc-highlight">Routing Queries</a></li></ul></li><li><a href="#bgp-implementation" class="table-of-contents__link toc-highlight">BGP Implementation</a><ul><li><a href="#exabgp" class="table-of-contents__link toc-highlight">ExaBGP</a></li><li><a href="#frrouting" class="table-of-contents__link toc-highlight">FRRouting</a></li></ul></li><li><a href="#routing-for-ipv4" class="table-of-contents__link toc-highlight">Routing for IPv4</a><ul><li><a href="#l2-tunneling" class="table-of-contents__link toc-highlight">L2 Tunneling</a></li><li><a href="#nat64" class="table-of-contents__link toc-highlight">NAT64</a></li></ul></li><li><a href="#policing-and-classification" class="table-of-contents__link toc-highlight">Policing and Classification</a></li><li><a href="#hqos-configuration" class="table-of-contents__link toc-highlight">HQoS Configuration</a><ul><li><a href="#vppctl" class="table-of-contents__link toc-highlight">vppctl</a></li><li><a href="#vpp_chaperone" class="table-of-contents__link toc-highlight">vpp_chaperone</a></li><li><a href="#weighted-round-robin-scheduling" class="table-of-contents__link toc-highlight">Weighted Round Robin Scheduling</a></li></ul></li><li><a href="#cpe-configuration" class="table-of-contents__link toc-highlight">CPE Configuration</a></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity/solutions/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/tgnms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph NMS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/terragraph-planner" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph Planner<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0199c3c1.js"></script>
<script src="/assets/js/main.c2ab4c5b.js"></script>
</body>
</html>