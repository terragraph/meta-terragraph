<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Timing_Synchronization">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Timing and Synchronization | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Timing_Synchronization"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Timing and Synchronization | Terragraph"><meta data-rh="true" name="description" content="This document describes Terragraph&#x27;s architecture for time synchronization."><meta data-rh="true" property="og:description" content="This document describes Terragraph&#x27;s architecture for time synchronization."><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Timing_Synchronization"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Timing_Synchronization" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Timing_Synchronization" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.0199c3c1.js" as="script">
<link rel="preload" href="/assets/js/main.c2ab4c5b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Communication_Protocol">Communication Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Routing_Layer">Routing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Interface">Driver Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Stack">Driver Stack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/VPP_Implementation">VPP Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/WiFi">Wi-Fi</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Timing and Synchronization</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Timing and Synchronization</h1><p>This document describes Terragraph&#x27;s architecture for time synchronization.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="introduction">Introduction<a class="hash-link" href="#introduction" title="Direct link to heading">​</a></h2><p>Absolute time and phase synchronization are essential for the correct operation
of a Terragraph network. The time division duplex (TDD) slot architecture of the
physical layer requires a timing precision less than the slot guard bands. In
addition, absolute time is required at each sector for the derivation of the
superframe number used for scheduling.</p><p>There are two possible approaches, explained further in the sections below:</p><ol><li><strong>GPS:</strong> GPS receivers co-located with each node can be used to synchronize
networks of arbitrary size.</li><li><strong>Over-the-air sync (or &quot;OTA sync&quot;):</strong> A single timing source can synchronize
downstream nodes over a limited number of hops using high-resolution TSF (or
&quot;HTSF&quot;) messages provided by Talyn firmware.</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gps">GPS<a class="hash-link" href="#gps" title="Direct link to heading">​</a></h3><p>The use of precise timing derived from a co-located GPS receiver meets timing
requirements, but it does present trade-offs:</p><ul><li>A node may not have clear sky visibility to at least 5 GPS satellites at all
times of the day, and thus may fail to provide a 3D fix with timing using GPS.</li><li>The cost of a GPS receiver is high, which reduces the likelihood that client
nodes (CNs) will have a GPS receiver.</li></ul><p>This document will describe the means to meet the network timing requirements
through a design that minimizes the dependence on GPS visibility, while still
meeting the timing precision requirements. The design accomplishes this as
follows:</p><ul><li><strong>Single satellite mode:</strong> By default, a GPS chip tries to estimate latitude,
longitude, altitude, and time. To solve for these 4 unknowns, it needs good
visibility of at least 4 satellites. Since Terragraph nodes are stationary
(i.e. latitude, longitude, and altitude are already known), and time is the
only unknown, a single satellite is enough to estimate time. This design uses
a GPS chip which supports single satellite mode (a.k.a. time-only mode).</li><li><strong>GPS survey-in mode:</strong> Used to sanitize and refine the position assist, when
available.</li><li><strong>RF sync:</strong> Fall back to air interface timestamps from a peer sector when GPS
is unavailable. Terragraph supports time propagation over 1 hop for DNs, and
over 2 hops for CNs. This means that a wireless link will stay up even if one
of the peers has bad GPS signal reception.</li></ul><a id="timing-synchronization-ota-sync"></a><h3 class="anchor anchorWithStickyNavbar_LWe7" id="ota-sync">OTA Sync<a class="hash-link" href="#ota-sync" title="Direct link to heading">​</a></h3><p>OTA sync uses nanosecond Tx/Rx timestamps with roughly 6ns accuracy to
synchronize absolute time between Terragraph nodes. This mechanism involves a
two-way timestamp exchange and compensates for estimated OTA propagation delay,
making timing error independent of link distance.</p><p align="center"><img loading="lazy" src="/figures/ota_sync.png" width="512" class="img_ev3q"></p><p>Sectors on downstream nodes are synchronized via a common 1pps signal going to
all sectors on the node. Each second a SW-HTSF 1pps message is sent from the
sector that is RF synced to all other sectors on the node. The common 1pps
signal does not need to be phase or frequency aligned to the timing reference;
all phase and frequency correction is done in software so only a fairly reliable
local clock is required.</p><p>Hardware requirements:</p><ul><li>Inter-sector sync requires a common 1pps signal to all basebands. The signal
can be generated by a GPS module, a dedicated clock chip (&quot;system
synchronizer&quot;), or a PPS output from the host processor if available (ex.
PTP hardware clock).</li></ul><p>Trade-offs and limitations:</p><ul><li><strong>Max hops:</strong> The default Terragraph frame structure tolerates up to 1µs of
timing error, which will limit the possible number of wireless hops from the
timing source. Up to 5 hops of OTA sync has been verified on an OTA network,
but a larger number of hops should be feasible.</li><li><strong>Y-street:</strong> The current implementation does not support all deployment
scenarios with Y-street topologies. Specifically, there is no mechanism for a
Y-street &quot;root node&quot; to decide which of two DN peers both in PPS sync should
be used as the source of timing. Additionally, at the Y-street root node time
cannot flow in one leg and out the other: there is no mechanism in wireless
firmware to support this scenario, so the second leg will not ignite. There is
no issue with time flowing from the root node to multiple DN peers.</li><li><strong>Mesh support:</strong> When a node is configured for SW-HTSF sync, the decision
about which sector to use as the timing source is made locally by the E2E
minion without knowledge about the path the timing signal took. In order to
avoid timing loops in mesh networks (which would result in loss of
synchronization) any change in the timing path (e.g. due to an upstream link
going down) requires a full link re-ignition. The current software
implementation accomplishes this through a configurable timer. This may limit
the size and complexity of mesh networks where GPS-free operation is practical
or desired.</li><li><strong>Dynamic PPS timestamp source:</strong> Current software does not support
dynamically changing the PPS timestamp source. Therefore, a node cannot
dynamically switch between using a local GPS as the timing reference and OTA
sync (e.g. when GPS loses sync). Additional changes in the E2E minion would be
required to support this scenario, but no wireless firmware changes are
required.</li></ul><p align="center"><img loading="lazy" src="/figures/ota_sync_example.svg" width="600" class="img_ev3q"></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="timing-and-synchronization-1">Timing and Synchronization<a class="hash-link" href="#timing-and-synchronization-1" title="Direct link to heading">​</a></h2><p>A node receives timing information in one of two ways:</p><ol><li>Directly through an input timing source (e.g. GPS, PTP hardware clock)</li><li>Indirectly through network messages</li></ol><h3 class="anchor anchorWithStickyNavbar_LWe7" id="synchronization-state-machine">Synchronization State Machine<a class="hash-link" href="#synchronization-state-machine" title="Direct link to heading">​</a></h3><p>The state machine for timing synchronization in firmware comprises three states,
which are as follows (in order of preference):</p><ul><li><strong>PPS sync (formerly &quot;GPS sync&quot;):</strong><ul><li><em>Entry condition:</em> Valid time samples have been received for a few
consecutive seconds (typically 2 seconds).</li><li><em>Exit condition:</em> Valid time samples have not been received for a few
consecutive seconds (typically 10 seconds).</li></ul></li><li><strong>RF sync:</strong> Not in &quot;PPS sync&quot;, but is reachable to a DN with &quot;PPS sync&quot; over
wireless links (1-2 hops away, as explained above).<ul><li><em>Entry condition:</em> Conditions for &quot;PPS sync&quot; have not been met, but a link
exists to at least one other DN from which to derive timing.</li><li><em>Exit condition:</em> Conditions for &quot;PPS sync&quot; have not been met and no links
to other DNs exist from which to derive timing.</li></ul></li><li><strong>No sync:</strong> Neither in PPS sync nor RF sync. This is the default state.<ul><li><em>Entry condition:</em> Conditions for &quot;PPS sync&quot; or &quot;RF sync&quot; are not met.</li><li><em>Exit condition:</em> Condition for &quot;PPS sync&quot; or &quot;RF sync&quot; are met.</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="time-sample-validity">Time Sample Validity<a class="hash-link" href="#time-sample-validity" title="Direct link to heading">​</a></h3><p>Time samples are collected each second. The components of the time sample and
its validity criteria and thresholds are defined as follows:</p><ul><li>The new time must be +1 when compared to the previous sample.</li><li>The TSF value must be greater than the TSF value latched at the previous 1pps
strobe by 1,000,000 ±20 µs.</li></ul><p>Other software layers may contain additional validity checks. For example, the
u-blox driver used on Rev5 enforced the following conditions:</p><ul><li>The internal oscillator offset and uncertainty reported by GPS must be within
±500 ppb.</li><li>The 1pps strobe time offset and uncertainty reported by GPS must be within
±500 ns.</li><li>There must be no software errors reported pertaining to the GPS, communication
with the GPS, or failure of the 1pps latch. Examples include I2C communication
errors between the GPS and CPU, or a stuck microcode for the 1pps latch.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="timing-constraints">Timing Constraints<a class="hash-link" href="#timing-constraints" title="Direct link to heading">​</a></h3><p>In order to ensure the synchronization of time slots for all sectors, the time
to perform certain operations in a sector must be constrained. A guard time
between slots provides the protection necessary to provide sufficient
synchronization. Additionally, a delayed Tx slot start time is needed for
successful reception of the first packet in the Tx slot.</p><p>The following diagram shows a synchronization timing slot, including a guard
time (8µs) and delayed start time for Tx slot (2µs).</p><p align="center"><img loading="lazy" src="/figures/slot_timing.svg" width="720" class="img_ev3q"></p><p>Terragraph timing slots have the following timing error constraints:</p><ul><li><strong>T_pps:</strong> Worst case is +/- 0.5µs for a 1µs error. For example, this may
happen due to poor GPS signal reception. Typically, this is 0.1µs.</li><li><strong>T_stamping, T_quantization:</strong> Worst case is 1µs.</li><li><strong>T_Propagation:</strong> 1µs for a 300 meter link.</li><li><strong>T_slot_switch:</strong> Worst case is 5.1µs for <strong>rx_slot</strong> end to <strong>rx_slot</strong>
start. This includes hardware processing time for the RF and PHY/MAC layers.</li></ul><p>Terragraph timing slot subframes have the following timing values:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Guard time of 8µs = (T_pps or T_Propagation) + T_quantization + T_Propagation + T_slot_switch</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Delayed Tx slot start time of 2µs = (T_pps or T_Propagation) + T_quantization</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><h3 class="anchor anchorWithStickyNavbar_LWe7" id="timing-correction">Timing Correction<a class="hash-link" href="#timing-correction" title="Direct link to heading">​</a></h3><p>The Timing Synchronization Function (TSF) is a 64-bit microsecond counter that
is used as a measure of time for all MAC operations. The software allows and
corrects finite drifts in the frequency.</p><p>More specifically, there are two TSF values:</p><ul><li><em>Hardware TSF (&quot;HW TSF&quot;):</em> The raw TSF values captured by the hardware
free-running TSF counter when events occur (ex. PPS, Tx/Rx). The HW TSF timer
gets updated only once during the initial setup of the MAC frame structure.</li><li><em>Software TSF (&quot;SW TSF&quot;):</em> The actual TSF time, i.e. HW TSF + TSF offset
maintained by software. This is the common Terragraph clock time at any
instant. Terragraph sectors achieve PPS/RF sync by tuning the TSF offset
values maintained in software.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="pps-sync-state">PPS Sync State<a class="hash-link" href="#pps-sync-state" title="Direct link to heading">​</a></h4><p>In the &quot;PPS sync&quot; state, the Terragraph clock is precisely disciplined by an
input timing source (e.g. GPS at typically 5ppb). Common sources of error
include PLL (phase-locked loop) least counts and GPS oscillator
offsets/uncertainties. The software uses a 1pps strobe to correct any drifts,
and applies the correction once per second at every 1pps strobe. The successive
1pps strobes should be 1 second apart. Any difference is applied as a timing
correction each second. The maximum correction applied is 20µs per second,
allowing correction of timing drifts within 20ppm.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rf-sync-state">RF Sync State<a class="hash-link" href="#rf-sync-state" title="Direct link to heading">​</a></h4><p>In the &quot;RF sync&quot; state, the software relies on a peer station&#x27;s timing. Peer
stations exchange management messages over the wireless link every 25ms. These
messages contain a transmit timestamp from the peer station, which must match
the local receive timestamp. Any difference between the local timestamp and the
timestamp in the frame gets applied as a timing correction every 25ms. The
maximum correction applied is 1µs per 25ms. This allows correction of timing
drifts within 40ppm.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ignition-and-link-management">Ignition and Link Management<a class="hash-link" href="#ignition-and-link-management" title="Direct link to heading">​</a></h2><p>When a node is in the &quot;RF sync&quot; state, timing is derived from a peer node.
However, timing errors can occur and accumulate at each hop, which degrades
timing. Terragraph places a limit on the number of hops allowed from a timing
source and controls the accumulation of timing errors by implementing the
following constraints:</p><ul><li>A DN may only ignite another DN if it is in the &quot;PPS sync&quot; state.</li><li>A DN may only ignite a CN if it is in the &quot;PPS sync&quot; or &quot;RF sync&quot; state.</li><li>A DN in the &quot;RF sync&quot; state will remove a link to a peer DN if the peer is not
in the &quot;PPS sync&quot; state.</li></ul><p>A <em>sync state indicator</em> (SSI) provides this information as follows:</p><ul><li>When a node gets its timing from network messages, the SSI will be the
number of hops between the local node and the node serving as the timing
source.</li><li>When a node gets its timing directly from an input timing source, the SSI will
be zero.</li><li>When a node is in the &quot;no sync&quot; state, the SSI will be 255.</li></ul><p>The table below shows the link management actions for each sync state. In the
current Terragraph implementation, X = 1.</p><table><thead><tr><th>Sync State</th><th>Initiate Link to Peer DN</th><th>Initiate Link to Peer CN</th><th>Accept Link Initiation from Peer DN</th><th>Delete Peer DN Link</th><th>Delete Peer CN Link</th></tr></thead><tbody><tr><td>PPS Sync</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>RF Sync <!-- -->[local SSI &lt; X]</td><td>Yes</td><td>Yes</td><td>Yes</td><td>No</td><td>No</td></tr><tr><td>RF Sync <!-- -->[local SSI &gt;= X]</td><td>No</td><td>Yes</td><td>Yes</td><td>Yes if peer SSI &gt;= X</td><td>Yes</td></tr><tr><td>No Sync</td><td>No</td><td>No</td><td>Yes</td><td>n/a</td><td>Yes</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="e2e-controller-and-gps-survey-in">E2E Controller and GPS Survey-In<a class="hash-link" href="#e2e-controller-and-gps-survey-in" title="Direct link to heading">​</a></h2><p>Where applicable, the configuration of the GPS receiver on each DN is handled by
the E2E controller. The E2E controller enables position-assisted GPS and
minimizes the need for user input. Since the DN is immobile, it uses the
&quot;survey-in&quot; feature to determine its own position. When a node is in &quot;survey-in&quot;
mode, it surveys the sky for satellites from which to get its geographic
coordinates (longitude and latitude). The node will remain in &quot;survey-in&quot; mode
until:</p><ul><li>It gets its GPS coordinates from a satellite.</li><li>&quot;Survey-in&quot; fails.</li><li>A user manually inputs the GPS coordinates.</li></ul><p>GPS coordinates are persisted by the E2E controller. When the E2E controller
does not have GPS coordinates recorded for any node, it gets them from
&quot;survey-in&quot; at the time of ignition. &quot;Survey-in&quot; fails only if a node never sees
more than 4 satellites. Such a node cannot be an initiator, but can still be
ignited as a responder. The user does not need to provide GPS coordinates except
in cases where &quot;survey-in&quot; fails, and any GPS coordinates entered manually must
have an accuracy of better than 50 meters.</p><p>For supported GPS modules, the E2E controller automatically configures single
satellite mode using its recorded GPS coordinates for each node.</p><p>Sectors must self-assert on GPS timing uncertainty greater than 0.5µs and revert
to the &quot;RF sync&quot; state.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>This section describes the timing architecture on Terragraph reference
platforms, and how to support additional GPS modules.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="terragraph-hardware">Terragraph Hardware<a class="hash-link" href="#terragraph-hardware" title="Direct link to heading">​</a></h3><p>Details from different Terragraph hardware revisions are summarized below.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="rev5-hardware">Rev5 Hardware<a class="hash-link" href="#rev5-hardware" title="Direct link to heading">​</a></h4><p>Rev5 hardware uses the u-blox LEA-M8F GPS module. The module is connected over
I2C, and NMEA message handling is done via an in-kernel driver (see
<code>recipes-radio/ublox-mod/kernel-module-ublox_0.1.bb</code>). Timestamp messages are
forwarded from the u-blox driver to the Terragraph driver, which sends them to
the wireless firmware. Single satellite mode is achieved using the u-blox
<code>UBX-CFG-TMODE2</code> (&quot;Time Mode&quot;) command.</p><p align="center"><img loading="lazy" src="/figures/gps_rev5.svg" width="512" class="img_ev3q"></p><p>Note that per u-blox specification, the GPS module is calibrated for a maximum
drift of 100ppb after 24 hours of holdover (a mode of operation where GPS timing
is temporarily maintained even after synchronization with GPS satellites is
lost). This implies that the GPS holdover state of u-blox in the first few
seconds after loss of GPS lock should be near precise.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="puma-hardware">Puma Hardware<a class="hash-link" href="#puma-hardware" title="Direct link to heading">​</a></h4><p>Puma hardware uses the Telit SL869-T GPS module and TG2520SMN crystal. The
module is connected over UART, and NMEA message handling is done via <a href="https://gpsd.gitlab.io/gpsd/index.html" target="_blank" rel="noopener noreferrer">gpsd</a>.
Terragraph&#x27;s <code>driver-if</code> connects to gpsd to receive timestamps, then forwards
them over Netlink (as <code>TGD_NLSDN_CMD_SET_GPS_TIME</code>) to the Terragraph driver to
send to the wireless firmware. Single satellite mode is achieved using the Telit
<code>$PSTMENABLEPOSITIONHOLD</code> (&quot;Position Hold&quot;) command.</p><p>Some functionality depends on a custom PPS source (default <code>/dev/pps1</code>) which
asserts on <code>ETS</code> interrupts from QorIQ&#x27;s PTP clock driver:</p><ul><li>gpsd handles the asserts from the PPS source. When <code>driver-if</code> receives a
corresponding PPS message from gpsd, it forwards the attached timestamp to
the wireless firmware.</li><li>System time is synchronized using a combination of PPS signals and GPS
messages (default <code>/dev/ttyS1</code>). When enabled, <code>chronyd</code> is configured to
sample GPS and PPS messages using the SHM and SOCK mechanisms via gpsd.</li></ul><p align="center"><img loading="lazy" src="/figures/gps_puma.svg" width="512" class="img_ev3q"></p><a id="timing-synchronization-puma-mbh-hardware"></a><h4 class="anchor anchorWithStickyNavbar_LWe7" id="puma-mbh-hardware">Puma MBH Hardware<a class="hash-link" href="#puma-mbh-hardware" title="Direct link to heading">​</a></h4><p>Specialized &quot;Puma MBH&quot; (Mobile Backhaul) builds include additional hardware to
support 1588v2 (PTP) and SyncE transport for time (phase) and frequency
synchronization. Refer to <a href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a> for more details about
these protocols and implementations.</p><p>The additional hardware includes:</p><ul><li>Microsemi ZL30795 system synchronizer (with SyncE DPLL), controlled by the
<code>zl3079x</code> driver (see
<code>recipes-radio/microsemi-dpll/kernel-module-zl3079x_0.1.bb</code>).</li><li>Microsemi VSC8254 dual 10G SFP+ PHY, controlled by the <code>malibu_char</code>
application (see <code>recipes-utils/vsc8254phy/vsc8254.bb</code>) built on the
user-space <a href="https://github.com/microchip-ung/mesa" target="_blank" rel="noopener noreferrer">MESA</a> library.</li></ul><p>Puma MBH offers PTP Transparent Clock (PTP-TC) Class A/B functionality with or
without GPS, and implements timestamping via one-step correction field update in
either of two layers:</p><ul><li><strong>NPU</strong> (NXP LS1048A) with ~20ns accuracy, implemented on the host in the
<code>ptptc</code> VPP plugin (see <code>recipes-facebook/vpp-ptptc/vpp-ptptc_0.1.bb</code>).</li><li><strong>10G PHY</strong> (Microsemi VSC8254) with ~1ns accuracy, statically configured
through <code>malibu_char</code>.</li></ul><p>The SyncE PLL loop filter is implemented in the <code>zl3079x</code> driver as a PI
controller, and is driven by phase error measurements contained in HTSF messages
from Talyn firmware every BWGD (25.6ms) via the Terragraph driver. Support for
the Ethernet Synchronization Messaging Channel (ESMC) protocol (ITU-T G.8264) is
handled by the <code>esmc</code> VPP plugin (see
<code>recipes-facebook/vpp-esmc/vpp-esmc_1.0.bb</code>).</p><p>The E2E minion (<code>PTPClockHelper</code> class) synchronizes clocks on the NPU and/or
10G PHY at each 1pps strobe as follows:</p><ul><li><strong>NPU</strong> via direct DPAA2 register reads/writes to synchronize the NXP PTP
hardware clock.</li><li><strong>10G PHY</strong> via a custom datagram socket protocol in <code>malibu_char</code> to
synchronize the VSC LTC (local time counter) clock.</li></ul><p align="center"><img loading="lazy" src="/figures/puma_mbh_arch.svg" width="600" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="gps-porting-guide">GPS Porting Guide<a class="hash-link" href="#gps-porting-guide" title="Direct link to heading">​</a></h3><p>Requirements and instructions for supporting other GPS modules are described
below.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="constraints">Constraints<a class="hash-link" href="#constraints" title="Direct link to heading">​</a></h4><p>Terragraph wireless firmware has the following hard requirements:</p><ul><li>The firmware must receive a periodic timestamp message (<code>TG_SB_GPS_TIME</code>
ioctl) shortly after every 1pps strobe to remain in &quot;GPS sync&quot;, with a maximum
gap of roughly 200ms.</li><li>The duty cycle for the PPS pulse should be less than 50%. More specifically, a
pulse width of roughly 200ms works well, but a width of 500ms results in
out-of-sync TSF values and subsequent ignition failures.</li></ul><h4 class="anchor anchorWithStickyNavbar_LWe7" id="code-changes">Code Changes<a class="hash-link" href="#code-changes" title="Direct link to heading">​</a></h4><p>It is recommended to use the gpsd architecture when possible; any GPS module
that can output NMEA0183-compliant messages will work with gpsd. This requires
fairly limited changes in the following places:</p><ul><li><strong>Node configuration:</strong> Add default hardware-specific node configuration
values for all <code>envParams.GPSD_*</code> entries. This defines the NMEA/PPS serial
ports, baud rate, NMEA time offset calibration factor, etc.</li><li><strong>Initial GPS configuration:</strong> Send any commands needed to configure the GPS
module before gpsd starts (e.g. setting pulse width, configuring NMEA output
messages). This is done as part of the gpsd SV script in
<code>recipes-support/gpsd/files/sv/gpsd.run</code>.</li><li><strong>Single satellite mode:</strong> If the GPS module supports single satellite mode
operation, send the command to configure it via <code>driver-if</code>:
<code>BaseDriverIf::sendLocationToGpsBase()</code> in
<code>src/terragraph-e2e/e2e/driver-if/BaseDriverIf.cpp</code>. For instance, this method
is triggered when the E2E controller sends down the node&#x27;s precise location.</li><li><strong>Non-standard NMEA0183 data:</strong> If the GPS module outputs non-standard data in
any non-proprietary NMEA0183 sentence, corrections should be applied (if
possible) in <code>driver-if</code> before any further processing takes place:
<code>GpsdClient::preprocessData()</code> in
<code>src/terragraph-e2e/e2e/driver-if/GpsdClient.cpp</code>. For example, a GPS module
may report WGS84 altitude where MSL altitude is expected, which would
invalidate some calculations within gpsd.</li></ul><p>If the GPS module is not compatible with gpsd, an alternative is to write a
kernel module implementing the Terragraph driver&#x27;s GPS interface, found in
<code>recipes-radio/wireless-mod/files/nl-driver-if-hdr/fb_tg_gps_driver_if.h</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="gps-stats">GPS Stats<a class="hash-link" href="#gps-stats" title="Direct link to heading">​</a></h2><p>Stats about GPS state are exported from wireless firmware, the u-blox driver,
and <code>driver-if</code> (when connected to gpsd). These are published by <code>driver-if</code> on
a ZMQ port (see <a href="/docs/developer/Stats_Events_Logs">Stats, Events, Logs</a> for details).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-stats">Firmware Stats<a class="hash-link" href="#firmware-stats" title="Direct link to heading">​</a></h3><p>GPS stats from wireless firmware are shown in the table below.</p><table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><code>tgf.MAC.gps.driverDelay</code></td><td>Driver ioctl delay from PPS tsf boundary (in microseconds)</td></tr><tr><td><code>tgf.MAC.gps.maxDriverDelay</code></td><td>Max of &quot;driverDelay&quot;</td></tr><tr><td><code>tgf.MAC.gps.numPpsErr</code></td><td>Number of PPS tsf read errors</td></tr><tr><td><code>tgf.MAC.gps.numTimelineErr</code></td><td>Number of errors due to firmware/driver taking more time</td></tr><tr><td><code>tgf.MAC.gps.numMissedSec</code></td><td>Number of times driver did not send GPS time (derived from tsf, and can increase by many counts per second)</td></tr><tr><td><code>tgf.MAC.gps.ppsJitter</code></td><td>Jitter for the last PPS tsf (in microseconds), only recording <em>valid</em> samples (i.e. PPS jitter &lt;= 25us) used for GPS drift correction</td></tr><tr><td><code>tgf.MAC.gps.maxPpsJitter</code></td><td>Max of &quot;ppsJitter&quot;, but counting <em>all</em> received samples (including samples with high PPS jitter)</td></tr><tr><td><code>tgf.MAC.gps.tsfDrift</code></td><td>Cumulative drift in tsf</td></tr><tr><td><code>tgf.MAC.gps.ppsHwTsf</code></td><td>HW TSF at last PPS</td></tr><tr><td><code>tgf.MAC.gps.ppsHwTsfNs</code></td><td>HW TSF at last PPS ns portion</td></tr><tr><td><code>tgf.MAC.gps.ppsSwTsf</code></td><td>SW TSF at last PPS</td></tr><tr><td><code>tgf.MAC.gps.ppsSwTsfNs</code></td><td>SW TSF at last PPS ns portion</td></tr><tr><td><code>tgf.MAC.tsf.syncModeGps</code></td><td>1 if tsf is in &quot;GPS sync&quot; state, otherwise 0</td></tr><tr><td><code>tgf.MAC.tsf.syncModeRf</code></td><td>1 if tsf is in &quot;RF sync&quot; state, otherwise 0</td></tr><tr><td><code>tgf.MAC.tsf.numRfFix</code></td><td>Number of times tsf offset fixed on &quot;RF sync&quot;</td></tr><tr><td><code>tgf.MAC.tsf.numGpsFix</code></td><td>Number of times tsf offset fixed on &quot;GPS sync&quot;</td></tr><tr><td><code>tgf.MAC.tsf.rfDrift</code></td><td>Largest value of tsf drift over current stats interval with regard to the RF link</td></tr><tr><td><code>tgf.MAC.tsf.sumRfFix</code></td><td>Sum of tsf fixes for &quot;RF sync&quot;</td></tr><tr><td><code>tgf.MAC.tsf.sumGpsFix</code></td><td>Sum of tsf fixes for &quot;GPS sync&quot;</td></tr><tr><td><code>tgf.MAC.tsf.offsetL</code></td><td>Low word of current offset (<code>sw_tsf - hw_tsf</code>)</td></tr><tr><td><code>tgf.MAC.tsf.offsetH</code></td><td>High word of current offset (<code>sw_tsf - hw_tsf</code>)</td></tr><tr><td><code>tgf.MAC.tsf.driftPerWin</code></td><td>Average drift per window (e.g. per 10s)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="driver-stats">Driver Stats<a class="hash-link" href="#driver-stats" title="Direct link to heading">​</a></h3><p>A subset of GPS stats from the u-blox driver and/or <code>driver-if</code> are shown in the
table below. These sources export a similar, but not identical, set of keys.
u-blox driver keys are constructed in <code>DriverIfUtil::processGpsStatus()</code>, and
gpsd keys in <code>GpsdClient::getStats()</code>.</p><table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><code>tgd.gpsStat.latitude</code></td><td>Latitude (decimal) in 1e7</td></tr><tr><td><code>tgd.gpsStat.longitude</code></td><td>Longitude (decimal) in 1e7</td></tr><tr><td><code>tgd.gpsStat.heightMsl</code></td><td>Height above mean sea level in millimeters</td></tr><tr><td><code>tgd.gpsStat.heightEllipsoid</code></td><td>Height above ellipsoid in millimeters</td></tr><tr><td><code>tgd.gpsStat.fixNumSat</code></td><td>Number of satellites used in Nav Solution (from NAV-PVT)</td></tr><tr><td><code>tgd.gpsStat.fixType</code></td><td>GNSS fix type: 0=no fix, 3=3D fix, 5=time-only fix (from NAV-PVT) for u-blox driver; or 0=unknown, 1=none, 2=2D fix, 3=3D fix for gpsd</td></tr><tr><td><code>tgd.gpsStat.gnssTmOfset</code></td><td>Time offset between the preceding pulse and GNSS top-of-second in nanoseconds (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.gnssTmUncert</code></td><td>Uncertainty of GNSS offset in nanoseconds (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.intOscOfset</code></td><td>Internal oscillator frequency offset in ppb (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.intOscUncert</code></td><td>Internal oscillator frequency uncertainty in ppb (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.discipSrc</code></td><td>Disciplining source identifier: 0=internal oscillator, 1=GNSS, 2..5=other (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.timTosFlag</code></td><td>Bitmap with information about locked pulse, leap second, RAIM, etc. (from TIM-TOS)</td></tr><tr><td><code>tgd.gpsStat.n.snr</code></td><td>Carrier-to-Noise Ratio (signal strength) in dBHz (from NAV-SVINFO)</td></tr><tr><td><code>tgd.gpsStat.n.quality</code></td><td>Signal quality indicator: 0=no signal, 1=searching signal, 2=signal acquired, 3=signal detected but unusable, 4=code locked and time synchronized, 5..7=code and carrier locked and time synchronized (from NAV-SVINFO)</td></tr><tr><td><code>tgd.gpsStat.n.flag</code></td><td>Bitmap for health, orbit info, etc. (from NAV-SVINFO)</td></tr><tr><td><code>tgd.gpsStat.n.elevation</code></td><td>Elevation in integer degrees (from NAV-SVINFO)</td></tr><tr><td><code>tgd.gpsStat.dataLenError</code></td><td>Length of invalid <code>t_gps_stat</code> buffer</td></tr><tr><td><code>tgd.gpsStat.svDataLenError</code></td><td>Length of invalid <code>t_gps_space_veh_info</code> buffer</td></tr><tr><td><code>tgd.gpsStat.unixTs</code></td><td>The UNIX timestamp associated with this GPS sample</td></tr><tr><td><code>tgd.gpsStat.MAC.numTsSent</code></td><td>Number of timestamps sent to firmware from <code>driver-if</code></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="node-configuration">Node Configuration<a class="hash-link" href="#node-configuration" title="Direct link to heading">​</a></h2><p>This section lists the node configuration fields related to the features
described above. For more detailed specifications, refer to the config metadata
file.</p><table><thead><tr><th>Category</th><th>Field(s)</th><th>Description</th></tr></thead><tbody><tr><td>PPS Sync</td><td></td><td></td></tr><tr><td></td><td><code>timingParams.PPS_TIMESTAMP_SOURCE</code></td><td>The time source for 1pps timestamps sent to wireless firmware (e.g. GPS, PTP, HTSF).</td></tr><tr><td></td><td><code>timingParams.HTSF_MAX_LOOP_SIZE</code><br><code>timingParams.HTSF_SRC_MAC</code></td><td>Additional parameters for networks using OTA sync (i.e. HTSF sync).</td></tr><tr><td></td><td><code>radioParamsBase.fwParams.forceGpsDisable</code></td><td>Disable synchronization checks in wireless firmware, and thus allow association in the &quot;RF sync&quot; state on both ends of the link. This will only work over 1 hop for DNs, and over 2 hops for CNs. This <em>cannot</em> be used for DN-to-DN links using OTA sync (i.e. HTSF sync).</td></tr><tr><td></td><td><code>radioParamsBase.fwParams.htsfSyncEnable</code></td><td>Enable HTSF sync.</td></tr><tr><td></td><td></td><td></td></tr><tr><td>GPS</td><td></td><td></td></tr><tr><td></td><td><code>envParams.GPSD_ENABLED</code></td><td>Enable the gpsd daemon and timestamp forwarding via <code>driver-if</code>.</td></tr><tr><td></td><td><code>envParams.GPSD_GPS_MODULE</code></td><td>The identifier (e.g. name/vendor) of the GPS module, which may enable module-specific functionality.</td></tr><tr><td></td><td><code>envParams.GPSD_DEVICE</code><br><code>envParams.GPSD_BAUD_RATE</code></td><td>GPS system parameters.</td></tr><tr><td></td><td><code>envParams.GPSD_POSITION_HOLD_ENABLED</code></td><td>Enable single-satellite mode opration on supported GPS modules.</td></tr><tr><td></td><td><code>envParams.GPSD_PPS_DEVICE</code><br><code>envParams.GPSD_NMEA_TIME_OFFSET</code></td><td>Synchronize system time to GPS/PPS via gpsd and chronyd.</td></tr><tr><td></td><td></td><td></td></tr><tr><td>PTP</td><td></td><td></td></tr><tr><td></td><td><code>timingParams.PTP_TIMER_SOURCE</code></td><td>The 1pps timestamp source used to synchronize the NXP PTP hardware clock and/or VSC LTC clock.</td></tr><tr><td></td><td><code>timingParams.PTP_DEVICE</code></td><td>Synchronize the NXP PTP hardware clock via the given device.</td></tr><tr><td></td><td><code>timingParams.PTP_VPP_INTERFACE</code><br><code>timingParams.PTP_VPP_OFFSET_NS</code><br><code>timingParams.PTP_VPP_NXP_PORT</code></td><td>Enable PTP-TC timestamping via NXP NPU in the <code>ptptc</code> VPP plugin.</td></tr><tr><td></td><td><code>timingParams.PTP_VSC_CTRL_SOCKET</code><br><code>timingParams.PTP_VSC_PORT</code></td><td>Enable PTP-TC timestamping via VSC 10G PHY, as well as LTC clock synchronization.</td></tr><tr><td></td><td></td><td></td></tr><tr><td>SyncE</td><td></td><td></td></tr><tr><td></td><td><code>timingParams.ESMC_ENABLED</code><br><code>timingParams.PTP_VSC_PORT</code></td><td>Configure the given VSC 10G PHY port for SyncE, and enable the <code>esmc</code> VPP plugin to generate and handle ESMC protocol frames on the corresponding interface (port 0 = <code>TenGigabitEthernet1</code>, port 1 = <code>TenGigabitEthernet0</code>).</td></tr><tr><td></td><td><code>radioParamsBase.fwParams.htsfMsgInterval</code></td><td>Enable per-BWGD HTSF messages (<code>TG_NB_HTSF_INFO</code>) containing the timing error between nodes in nanoseconds, which is computed by wireless firmware every keepalive. For SyncE operation, set this to 1 in order to pass the timing error signal to the SyncE PLL every BWGD. Otherwise, set this to 0 (default) to disable the messages and avoid unnecessary overhead for systems that do not support SyncE.</td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="ota-sync-deployment-notes">OTA Sync Deployment Notes<a class="hash-link" href="#ota-sync-deployment-notes" title="Direct link to heading">​</a></h2><p>Instructions and considerations for deploying GPS-free Terragraph networks are
given in the sections below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="configuration">Configuration<a class="hash-link" href="#configuration" title="Direct link to heading">​</a></h3><p>A network using OTA sync should apply the following node configuration:</p><ul><li><strong>Timing source node(s):</strong> Set <code>timingParams.PPS_TIMESTAMP_SOURCE</code> to <code>&quot;GPS&quot;</code>
(co-located GPS receiver) or <code>&quot;PTP&quot;</code> (free-running PTP hardware clock), which
determines the source of the 1pps timestamps sent to wireless firmware. For
example, the timing source node can be a single POP node; when using multiple
nodes, their clocks must be externally synchronized (e.g. via GPS or PTP).</li><li><strong>Other nodes:</strong> Set <code>timingParams.PPS_TIMESTAMP_SOURCE</code> to <code>&quot;SW_HTSF&quot;</code> so
that they derive timing from upstream HTSF messages.</li><li><strong>All nodes:</strong><ul><li>Set <code>envParams.GPSD_ENABLED</code> to <code>&quot;0&quot;</code> to disable gpsd features (unless
needed on a timing source node).</li><li>Set <code>timingParams.HTSF_MAX_LOOP_SIZE</code> to the largest possible timing loop
size (mesh networks only).</li></ul></li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="example-scenarios">Example Scenarios<a class="hash-link" href="#example-scenarios" title="Direct link to heading">​</a></h3><p>The following examples highlight several topologies where OTA sync is fully,
partially, or not supported.</p><p><em>Topology 1:</em> This topology is not a mesh topology and does not contain
Y-streets, so any DN can be configured as the timing source node. Multiple nodes
could be configured as timing source nodes if each node uses the same external
reference, such as GPS. However, nodes configured as timing source nodes cannot
dynamically switch to OTA sync without a configuration change.</p><p align="center"><img loading="lazy" src="/figures/ota_sync_topology_1.svg" width="900" class="img_ev3q"><br><em>Topology 1</em></p><p><em>Topology 2:</em> This topology contains a Y-street, so not all scenarios are
supported.</p><ul><li>If DN1 is configured as the timing reference node then the topology is
supported.</li><li>However, DN4 cannot be the timing reference node because depending on the
order in which links are ignited, DN1 could become a Y-street root node with
multiple DN peers in PPS sync, which is not supported.</li></ul><p align="center"><img loading="lazy" src="/figures/ota_sync_topology_2.svg" width="300" class="img_ev3q"><br><em>Topology 2</em></p><p><em>Topology 3:</em> This topology contains a Y-street, so not all scenarios are
supported.</p><ul><li>If DN2 is configured as the timing reference node then the topology is
supported.</li><li>If DN1 is configured as the timing reference the DN2-DN3 link will not ignite
because time cannot flow in one leg of a Y-street root node and out the other
leg, so this scenario is not supported.</li></ul><p align="center"><img loading="lazy" src="/figures/ota_sync_topology_3.svg" width="450" class="img_ev3q"><br><em>Topology 3</em></p><p><em>Topology 4:</em> This figure-8 topology does not contain any Y-streets so in
general is supported with any node configured as the timing reference node.
However, there are many possible ways for timing to flow, so to avoid timing
loops any link going down may result in a complete re-ignition of other links in
order to re-arrange the timing path.</p><p align="center"><img loading="lazy" src="/figures/ota_sync_topology_4.svg" width="512" class="img_ev3q"><br><em>Topology 4</em></p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://gpsd.gitlab.io/gpsd/index.html" target="_blank" rel="noopener noreferrer">gpsd</a> - GPS service daemon</li><li><a href="https://github.com/microchip-ung/mesa" target="_blank" rel="noopener noreferrer">MESA</a> - Microchip Ethernet Switch API</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Timing_Synchronization.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/VPP_Implementation"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">VPP Implementation</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/PTP_SyncE"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">PTP &amp; SyncE</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#introduction" class="table-of-contents__link toc-highlight">Introduction</a><ul><li><a href="#gps" class="table-of-contents__link toc-highlight">GPS</a></li><li><a href="#ota-sync" class="table-of-contents__link toc-highlight">OTA Sync</a></li></ul></li><li><a href="#timing-and-synchronization-1" class="table-of-contents__link toc-highlight">Timing and Synchronization</a><ul><li><a href="#synchronization-state-machine" class="table-of-contents__link toc-highlight">Synchronization State Machine</a></li><li><a href="#time-sample-validity" class="table-of-contents__link toc-highlight">Time Sample Validity</a></li><li><a href="#timing-constraints" class="table-of-contents__link toc-highlight">Timing Constraints</a></li><li><a href="#timing-correction" class="table-of-contents__link toc-highlight">Timing Correction</a></li></ul></li><li><a href="#ignition-and-link-management" class="table-of-contents__link toc-highlight">Ignition and Link Management</a></li><li><a href="#e2e-controller-and-gps-survey-in" class="table-of-contents__link toc-highlight">E2E Controller and GPS Survey-In</a></li><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#terragraph-hardware" class="table-of-contents__link toc-highlight">Terragraph Hardware</a></li><li><a href="#gps-porting-guide" class="table-of-contents__link toc-highlight">GPS Porting Guide</a></li></ul></li><li><a href="#gps-stats" class="table-of-contents__link toc-highlight">GPS Stats</a><ul><li><a href="#firmware-stats" class="table-of-contents__link toc-highlight">Firmware Stats</a></li><li><a href="#driver-stats" class="table-of-contents__link toc-highlight">Driver Stats</a></li></ul></li><li><a href="#node-configuration" class="table-of-contents__link toc-highlight">Node Configuration</a></li><li><a href="#ota-sync-deployment-notes" class="table-of-contents__link toc-highlight">OTA Sync Deployment Notes</a><ul><li><a href="#configuration" class="table-of-contents__link toc-highlight">Configuration</a></li><li><a href="#example-scenarios" class="table-of-contents__link toc-highlight">Example Scenarios</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity/solutions/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/tgnms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph NMS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/terragraph-planner" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph Planner<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0199c3c1.js"></script>
<script src="/assets/js/main.c2ab4c5b.js"></script>
</body>
</html>