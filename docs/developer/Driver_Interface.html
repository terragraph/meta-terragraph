<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Driver_Interface">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Driver Interface | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Driver_Interface"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Driver Interface | Terragraph"><meta data-rh="true" name="description" content="This document describes the interface between user space applications and the"><meta data-rh="true" property="og:description" content="This document describes the interface between user space applications and the"><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Driver_Interface"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Driver_Interface" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Driver_Interface" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.0199c3c1.js" as="script">
<link rel="preload" href="/assets/js/main.c2ab4c5b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Communication_Protocol">Communication Protocol</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Routing_Layer">Routing Layer</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Driver_Interface">Driver Interface</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Driver_Stack">Driver Stack</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/VPP_Implementation">VPP Implementation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/PTP_SyncE">PTP &amp; SyncE</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/WiFi">Wi-Fi</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Architecture</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Driver Interface</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Driver Interface</h1><p>This document describes the interface between user space applications and the
Terragraph driver and firmware.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="architecture">Architecture<a class="hash-link" href="#architecture" title="Direct link to heading">​</a></h2><p>The E2E minion is responsible for communicating with the Terragraph driver and
firmware via its <code>DriverApp</code> thread. <code>DriverApp</code> uses a ZMQ pair socket
(<code>ZMQ_PAIR</code>) to send and receive messages with the <em>driver interface</em>
(<code>driver-if</code>). <code>driver-if</code> then communicates with the Terragraph driver over a
Netlink socket.</p><p align="center"><img loading="lazy" src="/figures/driver_if.svg" width="320" class="img_ev3q"></p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="implementation">Implementation<a class="hash-link" href="#implementation" title="Direct link to heading">​</a></h3><p>Normally, <code>driver-if</code> runs as another thread on the E2E minion process (spawned
by the <code>Minion</code> main class). <code>driver-if</code> can run also in <em>daemon mode</em> without
<code>DriverApp</code> or other E2E minion modules by passing the <code>--driver_if_only</code> flag.</p><p>A dedicated <code>ZmqMonitor</code> instance is also spawned in a separate thread for
pushing driver and firmware stats (refer to
<a href="/docs/developer/Stats_Events_Logs">Stats, Events, Logs</a> for further details).</p><p><code>driver-if</code> is a subclass of <code>BaseDriverIf</code>, and holds a corresponding Netlink
socket subclass of <code>BaseNetlinkSocket</code>. The subclasses are based on the
machine&#x27;s architecture, listed in the table below. Note that the x86 classes
are intended for emulation only and are largely incomplete.</p><table><thead><tr><th>Architecture</th><th><code>BaseDriverIf</code></th><th><code>BaseNetlinkSocket</code></th></tr></thead><tbody><tr><td>ARM</td><td><code>ArmDriverIf</code></td><td><code>ArmNetlinkSocket</code></td></tr><tr><td>x86</td><td><code>X86DriverIf</code></td><td><code>X86NetlinkSocket</code></td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="message-handling">Message Handling<a class="hash-link" href="#message-handling" title="Direct link to heading">​</a></h3><p>Upon receiving a message from the <em>Netlink socket</em>, <code>driver-if</code> does the
following:</p><ol><li>Convert the Netlink message to a <code>DriverNlMessage</code> instance using the
<code>ArmNetlinkSocket::recvFunc_()</code> callback.</li><li>Convert the <code>DriverNlMessage</code> to the corresponding <code>thrift::Message</code>
structure using <code>DriverIfUtil::driverNl2IfMessage()</code>.</li><li>Filter out and handle specific messages, including:<ul><li><code>DR_RESP</code> - log driver acknowledgements</li><li><code>FW_STATS</code>, <code>DR_STAT_PUSH</code> - publish stats from the firmware or driver to
<code>ZmqMonitor</code></li><li><code>FW_HEALTHY</code> - write firmware health status for the watchdog</li><li><code>FW_PPS_HTSF_INFO</code> - HTSF timing information</li></ul></li><li>Forward remaining messages through the pair socket using
<code>BaseDriverIf::sendToDriverApp()</code>.</li></ol><p>Upon receiving a message from the <em>pair socket</em>, <code>driver-if</code> does the following:</p><ol><li>Handle the <code>thrift::Message</code> by invoking the corresponding function within
<code>BaseDriverIf::processMessage()</code>.</li><li>Convert the <code>thrift::Message</code> structure to a <code>DriverNlMessage</code> instance, then
send it to the driver as a Netlink message using
<code>ArmNetlinkSocket::sendMessage()</code>.</li></ol><p><code>driver-if</code> publishes the following stats related to Netlink I/O:</p><ul><li><code>tgd.nl.recv_ok</code> - number of Netlink messages received successfully</li><li><code>tgd.nl.recv_err</code> - number of Netlink messages received unsuccessfully</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="features">Features<a class="hash-link" href="#features" title="Direct link to heading">​</a></h3><p>Some other notable features of <code>driver-if</code> are described below.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="firmware-codebook-management">Firmware Codebook Management<a class="hash-link" href="#firmware-codebook-management" title="Direct link to heading">​</a></h5><p>The firmware downloads <em>codebooks</em> (tables of antenna weights) from <code>driver-if</code>
via <code>FW_GET_CODEBOOK</code> requests (<code>thrift::CodebookFetchReq</code>), which specify a
channel and range of beams. In order to respond with the correct codebook,
<code>driver-if</code> maintains state learned from the <code>NODE_INIT</code> and <code>NODE_INIT_NOTIFY</code>
message sequence for each radio, and captures relevant information (i.e. vendor,
initial beamforming procedure type, codebook variant) using the
<code>ArmDriverIf::RadioProperties</code> struct. <code>driver-if</code> will load codebooks on demand
and cache them for the lifecycle of the process.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="gps-management">GPS Management<a class="hash-link" href="#gps-management" title="Direct link to heading">​</a></h5><p><code>driver-if</code> contains an optional feature (enabled via the node configuration
flag <code>envParams.GPSD_ENABLED</code>) to connect to a local <a href="https://gpsd.gitlab.io/gpsd/" target="_blank" rel="noopener noreferrer">gpsd</a> socket (on port
2947). When enabled, <code>BaseDriverIf</code> creates a separate thread to read events
from gpsd using the <code>GpsdClient</code> class, which does the following:</p><ul><li>Forwards all received timestamps to each firmware instance via <code>GPS_SEND_TIME</code>
once per second (only if <code>timingParams.PPS_TIMESTAMP_SOURCE</code> is set to &quot;GPS&quot;
in the node configuration).</li><li>Pushes GPS stats via <code>DR_STAT_PUSH</code>.</li><li>Forwards received location data to each firmware instance via
<code>GPS_SET_POS_REQ</code> once only.</li></ul><p>For more details, see <a href="/docs/developer/Timing_Synchronization">Timing and Synchronization</a>.</p><h5 class="anchor anchorWithStickyNavbar_LWe7" id="pps-timestamp-forwarding">PPS Timestamp Forwarding<a class="hash-link" href="#pps-timestamp-forwarding" title="Direct link to heading">​</a></h5><p>More generally, <code>driver-if</code> can forward 1PPS timestamps to Terragraph firmware
from the following sources (<code>timingParams.PPS_TIMESTAMP_SOURCE</code> in the node
configuration) to enable GPS/PPS sync mode:</p><ul><li>GPS, via <code>GpsdClient</code> (as described above).</li><li>PTP hardware clock, via <code>PTPClockHelper</code>. This utilizes a separate thread to
read EXTTS events from a PTP device (<code>timingParams.PTP_DEVICE</code>) using the
<code>ioctl</code> command <code>PTP_EXTTS_REQUEST</code>.</li><li>Software HTSF messages from Terragraph firmware, via <code>BaseDriverIf</code>. On
multi-radio nodes with a common PPS signal to all baseband sectors, the
software HTSF PPS timestamps received from one RF sync sector are sent to the
other sectors to enable PPS sync mode. When multiple sectors are publishing
HTSF timestamps, <code>driver-if</code> picks the &quot;source&quot; sector based on the first
message received, and will not switch to a different source sector until
<code>timingParams.HTSF_MAX_LOOP_SIZE * 13</code> seconds have elapsed in order to avoid
timing loops in the network; this delay is based on the number of missed
seconds (PPS timestamps) before firmware will transition from PPS to RF sync
(or bring down a link). Alternatively, the source sector can be hardcoded via
the node configuration field <code>timingParams.HTSF_SRC_MAC</code>.</li></ul><p><code>driver-if</code> publishes the following stats to help monitor the state of timestamp
forwarding:</p><ul><li><code>tgd.gpsStat.MAC.numTsSent</code> - number of GPS timestamps forwarded to <code>MAC</code>
(only valid if <code>timingParams.PPS_TIMESTAMP_SOURCE</code> is set to &quot;GPS&quot;)</li><li><code>tgd.ptp.MAC.numTsSent</code> - number of PTP hardware clock timestamps forwarded to
<code>MAC</code></li><li><code>tgd.htsf.MAC.numTsSent</code> - number of software HTSF timestamps forwarded to
<code>MAC</code></li></ul><h5 class="anchor anchorWithStickyNavbar_LWe7" id="ptp-hardware-clock-sync">PTP Hardware Clock Sync<a class="hash-link" href="#ptp-hardware-clock-sync" title="Direct link to heading">​</a></h5><p><code>driver-if</code> can be configured to synchronize a node&#x27;s PTP (Precision Time
Protocol) hardware clock based on 1PPS messages from a given timing reference
(<code>timingParams.PTP_TIMER_SOURCE</code> in the node configuration) by correcting for
phase offset and drift. The PTP clock is synchronized to GPS time (not UTC).
Possible timing sources include a GPS device and software/hardware HTSF messages
from Terragraph firmware.</p><p>Currently, the following clock types are supported:</p><ul><li>NXP DPAA2 (Data Path Acceleration Architecture Gen2) PTP clock, via direct
register access.</li><li>VSC 10G &quot;Malibu&quot; PHY LTC (local time counter) clock, via a custom datagram
socket protocol patched over the user-space &quot;MESA&quot; API. This can be enabled
by setting the node configuration field <code>envParams.PTP_VSC_CTRL_SOCKET</code> to any
valid path, which will be used for communication between <code>e2e_minion</code> and
<code>malibu_char</code>.</li></ul><h3 class="anchor anchorWithStickyNavbar_LWe7" id="performance-requirements">Performance Requirements<a class="hash-link" href="#performance-requirements" title="Direct link to heading">​</a></h3><p><code>driver-if</code> must be able to process messages in a timely manner, and major
issues may emerge here if the host CPU is overloaded. Some common examples are
described below.</p><ul><li><p><strong>PPS timestamp forwarding.</strong> On PPS sync nodes, <code>driver-if</code> must reliably
send timestamps to Terragraph firmware once per second, and 10 missed seconds
may cause a link to go down.</p><ul><li><em>Signs:</em> <code>LINK_DOWN</code> events with reason <code>SYSTEM_GPS_SYNC_IN_PROG</code>;
incrementing counter <code>tgf.MAC.gps.numMissedSec</code> (despite stable GPS fix,
if applicable)</li><li><em>Workarounds:</em> Increase scheduling priority of gpsd (if applicable) or
<code>driver-if</code>, e.g. using the <code>nice</code> command</li></ul></li><li><p><strong>Netlink communication.</strong> <code>driver-if</code> must receive northbound messages from
Terragraph firmware faster than they are produced to avoid dropping any
Netlink messages.</p><ul><li><em>Signs:</em> Netlink errors reported by <code>driver-if</code> and Terragraph driver (ex.
<code>ENOBUFS</code>), esp. as number of wireless links increases; incrementing
counter <code>tgd.nl.recv_err</code></li><li><em>Workarounds:</em> Reduce firmware stats frequency
(<code>radioParamsBase.fwParams.statsLogInterval</code>); omit some firmware stats
categories (<code>radioParamsBase.fwStatsConfig.&lt;category&gt; = false</code>)</li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="message-formats">Message Formats<a class="hash-link" href="#message-formats" title="Direct link to heading">​</a></h2><p><code>driver-if</code> handles the translation between Thrift messages (user space) and
Netlink messages (driver).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="netlink">Netlink<a class="hash-link" href="#netlink" title="Direct link to heading">​</a></h3><p>Netlink types are enumerated in <code>tgd_nlsdn_commands</code>, defined inside
<code>nl-driver-if/fb_tgd_nlsdn_common.h</code>. These are manually mapped to
<code>DriverNlMessageType</code> enum values inside <code>driver-if/DriverNlMessage.h</code>.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="thrift">Thrift<a class="hash-link" href="#thrift" title="Direct link to heading">​</a></h3><p>All Thrift messages to and from the driver use the same <code>thrift::DriverMessage</code>
base structure defined in <code>DriverMessage.thrift</code>:</p><div class="language-c codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-c codeBlock_bY9V thin-scrollbar"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">struct</span><span class="token plain"> </span><span class="token class-name">DriverMessage</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">1</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> binary value</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token number" style="color:#36acaa">2</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> string radioMac</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="Copy code to clipboard" title="Copy" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg class="copyButtonIcon_y97N" viewBox="0 0 24 24"><path d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg class="copyButtonSuccessIcon_LjdS" viewBox="0 0 24 24"><path d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><code>value</code> contains the compact-serialized binary value of the actual Thrift
structure, and <code>radioMac</code> is the origin or destination baseband MAC address
required for multi-baseband boards.</p><p>Note that this structure must be wrapped inside of a <code>thrift::Message</code>
structure, like with all other messages (refer to
<a href="/docs/developer/Communication_Protocol">Communication Protocol</a> for further details). Thus,
the actual message type is double-serialized, and the <code>mType</code> field in the outer
structure describes the message type of the actual message (i.e. innermost
structure).</p><p>Messages directly between <code>driver-if</code> and firmware use the <em>pass-through</em>
(<code>PassThru</code>) framework, with messages defined in <code>PassThru.thrift</code>. The base
message type is <code>thrift::PassThruMsg</code>, with all possible messages embedded as
nested structures and a separate message type field, <code>msgType</code>, enumerated in
<code>thrift::PtMsgTypes</code>. When sending pass-through messages over Netlink, the
<code>DriverNlMessageType</code> type for southbound messages (i.e. towards firmware) is
<code>PASSTHRU_SB</code> and the type for northbound messages (i.e. towards <code>driver-if</code>) is
<code>PASSTHRU_NB</code>.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="command-line-interfaces">Command-Line Interfaces<a class="hash-link" href="#command-line-interfaces" title="Direct link to heading">​</a></h2><p>When run in daemon mode, interaction with <code>driver-if</code> is typically done via CLI
applications, described below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="r2d2-cli">&quot;r2d2&quot; CLI<a class="hash-link" href="#r2d2-cli" title="Direct link to heading">​</a></h3><p><code>r2d2</code> is a Python-based command-line utility solely for communicating with
<code>driver-if</code> and its <code>ZmqMonitor</code> instance. This is mainly used for debugging and
automated testing purposes. For further implementation details, refer to
descriptions of the <code>tg</code> CLI, which has a similar architecture (see
<a href="/docs/developer/Terragraph_CLI#terragraph-cli-tg-cli">&quot;tg&quot; CLI</a>).</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="tg2-cli">&quot;tg2&quot; CLI<a class="hash-link" href="#tg2-cli" title="Direct link to heading">​</a></h3><p>The majority of <code>r2d2</code> functionality is also provided as part of the Lua-based
<code>tg2</code> CLI. Commands and syntax are nearly identical, although there may be minor
differences between argument/option names, program output, description text,
etc. A table mapping <code>r2d2</code> commands to <code>tg2</code> commands is given below:</p><table><thead><tr><th><code>r2d2</code> command</th><th><code>tg2</code> command</th></tr></thead><tbody><tr><td><code>r2d2 *</code></td><td><code>tg2 fw *</code></td></tr><tr><td><code>r2d2 fw_stats</code></td><td><code>tg2 stats driver-if</code></td></tr><tr><td><code>r2d2 fw_set_golay</code><br><code>r2d2 sync_bf_slot_exclusion_req</code><br><code>r2d2 sync_scan</code></td><td><em>unsupported</em></td></tr></tbody></table><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://gpsd.gitlab.io/gpsd/" target="_blank" rel="noopener noreferrer">gpsd</a> - GPS service daemon</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Driver_Interface.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Routing_Layer"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Routing Layer</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Driver_Stack"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Driver Stack</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#architecture" class="table-of-contents__link toc-highlight">Architecture</a><ul><li><a href="#implementation" class="table-of-contents__link toc-highlight">Implementation</a></li><li><a href="#message-handling" class="table-of-contents__link toc-highlight">Message Handling</a></li><li><a href="#features" class="table-of-contents__link toc-highlight">Features</a></li><li><a href="#performance-requirements" class="table-of-contents__link toc-highlight">Performance Requirements</a></li></ul></li><li><a href="#message-formats" class="table-of-contents__link toc-highlight">Message Formats</a><ul><li><a href="#netlink" class="table-of-contents__link toc-highlight">Netlink</a></li><li><a href="#thrift" class="table-of-contents__link toc-highlight">Thrift</a></li></ul></li><li><a href="#command-line-interfaces" class="table-of-contents__link toc-highlight">Command-Line Interfaces</a><ul><li><a href="#r2d2-cli" class="table-of-contents__link toc-highlight">&quot;r2d2&quot; CLI</a></li><li><a href="#tg2-cli" class="table-of-contents__link toc-highlight">&quot;tg2&quot; CLI</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity/solutions/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/tgnms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph NMS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/terragraph-planner" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph Planner<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0199c3c1.js"></script>
<script src="/assets/js/main.c2ab4c5b.js"></script>
</body>
</html>