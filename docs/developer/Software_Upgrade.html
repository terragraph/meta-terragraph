<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper docs-doc-page docs-version-current plugin-docs plugin-id-default docs-doc-id-developer/Software_Upgrade">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.21">
<link rel="search" type="application/opensearchdescription+xml" title="Terragraph" href="/opensearch.xml">
<link rel="stylesheet" href="/katex/katex.min.css"><title data-rh="true">Software Upgrade | Terragraph</title><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" name="twitter:image" content="https://terragraph.com/logo/terragraph-logo-full-RGB.png"><meta data-rh="true" property="og:url" content="https://terragraph.com/docs/developer/Software_Upgrade"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Software Upgrade | Terragraph"><meta data-rh="true" name="description" content="This document describes the in-band software upgrade procedure for Terragraph"><meta data-rh="true" property="og:description" content="This document describes the in-band software upgrade procedure for Terragraph"><link data-rh="true" rel="icon" href="/logo/terragraph-logo-favicon-32x32-full-RGB.png"><link data-rh="true" rel="canonical" href="https://terragraph.com/docs/developer/Software_Upgrade"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Software_Upgrade" hreflang="en"><link data-rh="true" rel="alternate" href="https://terragraph.com/docs/developer/Software_Upgrade" hreflang="x-default"><link data-rh="true" rel="preconnect" href="https://TB9T0CGM6Y-dsn.algolia.net" crossorigin="anonymous"><link rel="stylesheet" href="/assets/css/styles.48218837.css">
<link rel="preload" href="/assets/js/runtime~main.0199c3c1.js" as="script">
<link rel="preload" href="/assets/js/main.c2ab4c5b.js" as="script">
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div role="region"><a href="#" class="skipToContent_fXgn">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/logo/terragraph-logo-favicon-32x32-full-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--light_HNdA"><img src="/logo/terragraph-logo-favicon-32x32-white-RGB.svg" alt="Terragraph Logo" class="themedImage_ToTc themedImage--dark_i4oU"></div></a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link githubButton navbarIconButton" title="GitHub"></a><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link discordButton navbarIconButton" title="Discord"></a><div class="navbar__item dropdown dropdown--hoverable dropdown--right"><a href="#" aria-haspopup="true" aria-expanded="false" role="button" class="navbar__link">Docs</a><ul class="dropdown__menu"><li><a class="dropdown__link" href="/docs/runbook">Runbook</a></li><li><a aria-current="page" class="dropdown__link dropdown__link--active" href="/docs/developer">Developer Manual</a></li><li><a class="dropdown__link" href="/docs/whitepapers">Whitepapers</a></li></ul></div><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="Switch between dark and light mode (currently light mode)" aria-label="Switch between dark and light mode (currently light mode)"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="searchBox_ZlJk"><button type="button" class="DocSearch DocSearch-Button" aria-label="Search"><span class="DocSearch-Button-Container"><svg width="20" height="20" class="DocSearch-Search-Icon" viewBox="0 0 20 20"><path d="M14.386 14.386l4.0877 4.0877-4.0877-4.0877c-2.9418 2.9419-7.7115 2.9419-10.6533 0-2.9419-2.9418-2.9419-7.7115 0-10.6533 2.9418-2.9419 7.7115-2.9419 10.6533 0 2.9419 2.9418 2.9419 7.7115 0 10.6533z" stroke="currentColor" fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round"></path></svg><span class="DocSearch-Button-Placeholder">Search</span></span><span class="DocSearch-Button-Keys"></span></button></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docsWrapper_BCFX"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docPage__5DB"><aside class="theme-doc-sidebar-container docSidebarContainer_b6E3"><div class="sidebar_njMd"><nav class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--active" aria-expanded="true" href="/docs/developer">Developer Manual</a><button aria-label="Toggle the collapsible sidebar category &#x27;Developer Manual&#x27;" type="button" class="clean-btn menu__caret"></button></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Overview">Overview</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Communication_Protocol">Architecture</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Beamforming_Link_Adaptation">Firmware Layer</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" aria-expanded="true" tabindex="0" href="/docs/developer/Topology_Management">End-to-End (E2E) Service</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Topology_Management">Topology Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Ignition">Network Ignition</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/docs/developer/Software_Upgrade">Software Upgrade</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Configuration_Management">Configuration Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Scans">Scans</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Network_Measurements">Network Measurements</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Prefix_Allocation">Prefix Allocation</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/docs/developer/Topology_Discovery">Topology Discovery</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Stats_Events_Logs">Application Layer Modules</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Service_Scripts">System Management</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" aria-expanded="false" tabindex="0" href="/docs/developer/Release_Conventions">Version Control</a></div></li></ul></li></ul></nav><button type="button" title="Collapse sidebar" aria-label="Collapse sidebar" class="button button--secondary button--outline collapseSidebarButton_PEFL"><svg width="20" height="20" aria-hidden="true" class="collapseSidebarButtonIcon_kv0_"><g fill="#7a7a7a"><path d="M9.992 10.023c0 .2-.062.399-.172.547l-4.996 7.492a.982.982 0 01-.828.454H1c-.55 0-1-.453-1-1 0-.2.059-.403.168-.551l4.629-6.942L.168 3.078A.939.939 0 010 2.528c0-.548.45-.997 1-.997h2.996c.352 0 .649.18.828.45L9.82 9.472c.11.148.172.347.172.55zm0 0"></path><path d="M19.98 10.023c0 .2-.058.399-.168.547l-4.996 7.492a.987.987 0 01-.828.454h-3c-.547 0-.996-.453-.996-1 0-.2.059-.403.168-.551l4.625-6.942-4.625-6.945a.939.939 0 01-.168-.55 1 1 0 01.996-.997h3c.348 0 .649.18.828.45l4.996 7.492c.11.148.168.347.168.55zm0 0"></path></g></svg></button></div></aside><main class="docMainContainer_gTbr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_GujU"><div class="docItemContainer_Adtb"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_OVgt"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item"><a class="breadcrumbs__link" itemprop="item" href="/docs/developer"><span itemprop="name">Developer Manual</span></a><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">End-to-End (E2E) Service</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Software Upgrade</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_aoJ5"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><h1>Software Upgrade</h1><p>This document describes the in-band software upgrade procedure for Terragraph
nodes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-stages">Upgrade Stages<a class="hash-link" href="#upgrade-stages" title="Direct link to heading">​</a></h2><p>The controller&#x27;s <code>UpgradeApp</code> manages in-band software upgrades. An upgrade is
divided into two stages:</p><ol><li><strong>Prepare</strong>: A new software image is distributed to nodes in the network.
Each minion downloads the image, verifies its integrity, and flashes it to
its secondary disk partition.</li><li><strong>Commit</strong>: Nodes are instructed to switch to the new software image. Each
minion swaps its primary and secondary disk partitions and performs a full
reboot. This stage is disruptive, and may affect other elements in the
network.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="parallelization">Parallelization<a class="hash-link" href="#parallelization" title="Direct link to heading">​</a></h2><p>Within each upgrade stage, commands are executed across multiple nodes in
parallel. The specifics are given in the sections below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="prepare-stage">&quot;Prepare&quot; Stage<a class="hash-link" href="#prepare-stage" title="Direct link to heading">​</a></h3><p>Software images are distributed over BitTorrent by default. The controller seeds
each image through its own BitTorrent tracker, and sends the magnet URIs to each
minion to download. Alternatively, images can be distributed over HTTP or HTTPS
by sending the web URL instead; the images must be hosted via an external HTTP
server (ex. nginx in the default Docker Swarm deployment).</p><p>The distribution of software images is fully parallelizable, with the only
concern being high bandwidth utilization. This can be limited by setting speed
limits in each BitTorrent client, or by limiting the number of nodes downloading
the image at any point in time (&quot;batching&quot;).</p><p>When using BitTorrent, both the controller and minion will publish the following
stats during the &quot;prepare&quot; stage:</p><table><thead><tr><th>Key</th><th>Description</th></tr></thead><tbody><tr><td><code>upgrade.bt.progressPpm</code></td><td>The torrent download progress in parts per million, i.e. <code>[0,1000000]</code></td></tr><tr><td><code>upgrade.bt.seeds</code></td><td>The number of connected peers that are seeding the torrent</td></tr><tr><td><code>upgrade.bt.peers</code></td><td>The number of connected peers</td></tr><tr><td><code>upgrade.bt.connections</code></td><td>The number of peer connections, including half-open connections</td></tr><tr><td><code>upgrade.bt.downloadBps</code></td><td>The total download rate for all peers (in bps)</td></tr><tr><td><code>upgrade.bt.uploadBps</code></td><td>The total upload rate for all peers (in bps)</td></tr><tr><td><code>upgrade.bt.downloadPayloadBytes</code></td><td>The numer of payload bytes received during this session (ignoring protocol overhead)</td></tr><tr><td><code>upgrade.bt.uploadPayloadBytes</code></td><td>The numer of payload bytes sent during this session (ignoring protocol overhead)</td></tr></tbody></table><h3 class="anchor anchorWithStickyNavbar_LWe7" id="commit-stage">&quot;Commit&quot; Stage<a class="hash-link" href="#commit-stage" title="Direct link to heading">​</a></h3><p>The commit of new images is more difficult to parallelize, as nodes must reboot
to apply the new image. A reboot brings down all of a node&#x27;s wireless and
Ethernet links, potentially disconnecting parts of the network (&quot;network
isolation&quot;). A bad sequence of reboots could repeatedly isolate the same
portions of the network.</p><p>The commit parallelization algorithm is designed as follows:</p><ol><li>Avoid network isolation. If upgrading a node must cause network
isolation (due to poor network design), then upgrade the isolated portion of
the network at the same time.</li><li>Upgrade entire sites at once. This simplifies the graph logic, and aligns
with future DN hardware (i.e. single nodes with multiple radios).</li><li>Commit sites that are one hop away from another reachable site (when
possible). This reduces the amount of time required to re-ignite sites.</li></ol><p>The parallelization algorithm is a two-step procedure, and contained within
<code>GraphHelper</code>. The steps are described below.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-1-identify-articulation-points">Step 1: Identify Articulation Points<a class="hash-link" href="#step-1-identify-articulation-points" title="Direct link to heading">​</a></h4><p>In a connected graph, a vertex is called an <em><a href="https://www.geeksforgeeks.org/articulation-points-or-cut-vertices-in-a-graph/" target="_blank" rel="noopener noreferrer">articulation point</a></em> (AP) if
removing it would result in a disconnected graph. In the commit algorithm, APs
are the sites that will isolate portions of the network if taken down or removed
from the topology.</p><p>In the example below, site F is identified as an AP because taking it down would
isolate sites H and G.</p><p align="center"><img loading="lazy" src="/figures/upgrade_ap.svg" width="750" class="img_ev3q"></p><p>After identifying all APs, the list is filtered further to remove any &quot;sub-APs&quot;
(i.e. APs isolated by other APs). Each AP forms an &quot;AP group&quot;, consisting of
itself and all sites it isolates. All sites in an AP group will be updated
simultaneously in the same batch.</p><p>In the previous example, sites F, H, and G form an AP group and are treated as a
single virtual site.</p><h4 class="anchor anchorWithStickyNavbar_LWe7" id="step-2-select-leaf-sites">Step 2: Select Leaf Sites<a class="hash-link" href="#step-2-select-leaf-sites" title="Direct link to heading">​</a></h4><p>Once all AP groups are identified, each site or AP group is now accessible via
multiple paths. The graph is then converted into a spanning tree using a custom
spanning tree decomposition algorithm, which is a modified DFS with a bias
toward previously-upgraded sites. This will influence previously-upgraded sites
to form the core of the tree, rather than the edge.</p><p>Leaf sites in the resulting spanning tree can be upgraded simultaneously (in a
&quot;batch&quot;) without causing any disruption to other sites in the spanning tree. The
spanning tree algorithm is repeated until each site is picked once, resulting in
several &quot;batches&quot;.</p><p>Using the same example from above, the following illustration shows this step of
the algorithm, which requires three iterations to perform a full network
upgrade.</p><p align="center"><img loading="lazy" src="/figures/upgrade_tree.svg" width="750" class="img_ev3q"></p><p>The controller sends commit requests to all nodes in an upgrade batch. Once the
operation is complete, the two-step algorithm is run again to identify the next
batch. The algorithm always uses the current network state when computing the
next batch, accounting for any topology changes that might have occurred between
steps.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="mixed-hardware-upgrades">Mixed Hardware Upgrades<a class="hash-link" href="#mixed-hardware-upgrades" title="Direct link to heading">​</a></h2><p>Different node hardware may require different software images; the list of
supported hardware board IDs is written in each image&#x27;s metadata section
(<code>thrift::ImageMeta::hardwareBoardIds</code>). The following procedure is used to
upgrade a network with mixed node hardware:</p><ol><li>Issue a &quot;prepare&quot; request for each software image.</li><li>Issue a single &quot;commit&quot; request for all nodes.</li></ol><h2 class="anchor anchorWithStickyNavbar_LWe7" id="golden-images">Golden Images<a class="hash-link" href="#golden-images" title="Direct link to heading">​</a></h2><p>The controller can be configured to automatically upgrade nodes to a &quot;golden
image&quot; through the controller configuration field <code>upgradeParams.goldenImage</code>.
When enabled, the controller periodically looks for nodes running software
versions older than the golden image (by comparing major/minor numbers only)
and schedules &quot;prepare&quot; and &quot;commit&quot; procedures back-to-back for these nodes.</p><h2 class="anchor anchorWithStickyNavbar_LWe7" id="message-interface">Message Interface<a class="hash-link" href="#message-interface" title="Direct link to heading">​</a></h2><p>All controller messages related to upgrades are described below.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="upgrade-procedure">Upgrade Procedure<a class="hash-link" href="#upgrade-procedure" title="Direct link to heading">​</a></h3><p>The following commands address the upgrade procedure itself:</p><table><thead><tr><th>User Operation</th><th>Command</th></tr></thead><tbody><tr><td>Send Upgrade Request</td><td><code>UPGRADE_GROUP_REQ</code></td></tr><tr><td>Abort Upgrade</td><td><code>UPGRADE_ABORT_REQ</code></td></tr><tr><td>Get Upgrade State</td><td><code>UPGRADE_STATE_REQ</code></td></tr><tr><td>Get Upgrade Commit Plan</td><td><code>UPGRADE_COMMIT_PLAN_REQ</code></td></tr></tbody></table><p>All types of upgrades are initiated via the <code>UpgradeGroupReq</code> structure, which
contains the nodes to upgrade and a nested <code>UpgradeReq</code> structure that defines
the actual upgrade procedure. The type of upgrade is determined by the
<code>thrift::UpgradeReqType</code> enum:</p><ul><li><code>PREPARE_UPGRADE</code> - The &quot;prepare&quot; stage (described above).</li><li><code>COMMIT_UPGRADE</code> - The &quot;commit&quot; stage (described above).</li><li><code>FULL_UPGRADE</code> - Execute the &quot;prepare&quot; and &quot;commit&quot; stages back-to-back.</li><li><code>RESET_STATUS</code> - Reset each node&#x27;s local upgrade state, and cancel any ongoing
image downloads or scheduled commits.</li></ul><p>All upgrade requests are forwarded from the controller to minions via the
<code>UPGRADE_REQ</code> message.</p><h3 class="anchor anchorWithStickyNavbar_LWe7" id="software-image-management">Software Image Management<a class="hash-link" href="#software-image-management" title="Direct link to heading">​</a></h3><p>The following commands manage the software images hosted and seeded by the
controller:</p><table><thead><tr><th>User Operation</th><th>Command</th></tr></thead><tbody><tr><td>Add Upgrade Image</td><td><code>UPGRADE_ADD_IMAGE_REQ</code></td></tr><tr><td>Delete Upgrade Image</td><td><code>UPGRADE_DEL_IMAGE_REQ</code></td></tr><tr><td>List Upgrade Images</td><td><code>UPGRADE_LIST_IMAGES_REQ</code></td></tr></tbody></table><p>The <code>thrift::UpgradeImage</code> structure contains the URIs for downloading the
software images:</p><ul><li><code>magnetUri</code> - The magnet URI (i.e. for BitTorrent)</li><li><code>httpUri</code> - The HTTP URI (only set if HTTP serving is enabled)</li></ul><h2 class="anchor anchorWithStickyNavbar_LWe7" id="resources">Resources<a class="hash-link" href="#resources" title="Direct link to heading">​</a></h2><ul><li><a href="https://www.geeksforgeeks.org/articulation-points-or-cut-vertices-in-a-graph/" target="_blank" rel="noopener noreferrer">articulation point</a> - Articulation point algorithms</li></ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="theme-doc-footer-edit-meta-row row"><div class="col"><a href="https://github.com/terragraph/meta-terragraph/edit/main/docs/../docs/developer/Software_Upgrade.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_eYIM" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_vbeJ"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><a class="pagination-nav__link pagination-nav__link--prev" href="/docs/developer/Network_Ignition"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Network Ignition</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/docs/developer/Configuration_Management"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Configuration Management</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#upgrade-stages" class="table-of-contents__link toc-highlight">Upgrade Stages</a></li><li><a href="#parallelization" class="table-of-contents__link toc-highlight">Parallelization</a><ul><li><a href="#prepare-stage" class="table-of-contents__link toc-highlight">&quot;Prepare&quot; Stage</a></li><li><a href="#commit-stage" class="table-of-contents__link toc-highlight">&quot;Commit&quot; Stage</a></li></ul></li><li><a href="#mixed-hardware-upgrades" class="table-of-contents__link toc-highlight">Mixed Hardware Upgrades</a></li><li><a href="#golden-images" class="table-of-contents__link toc-highlight">Golden Images</a></li><li><a href="#message-interface" class="table-of-contents__link toc-highlight">Message Interface</a><ul><li><a href="#upgrade-procedure" class="table-of-contents__link toc-highlight">Upgrade Procedure</a></li><li><a href="#software-image-management" class="table-of-contents__link toc-highlight">Software Image Management</a></li></ul></li><li><a href="#resources" class="table-of-contents__link toc-highlight">Resources</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Terragraph</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/docs/runbook/Overview">Overview</a></li><li class="footer__item"><a href="https://www.facebook.com/connectivity/solutions/terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">Meta Connectivity<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/terragraph/meta-terragraph" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discord.gg/HQaxCevzus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/tgnms" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph NMS<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://github.com/terragraph/terragraph-planner" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terragraph Planner<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://opensource.facebook.com/legal/privacy/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Privacy<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://opensource.facebook.com/legal/terms/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Terms<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_lCJq"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2022 Meta Platforms, Inc. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.0199c3c1.js"></script>
<script src="/assets/js/main.c2ab4c5b.js"></script>
</body>
</html>